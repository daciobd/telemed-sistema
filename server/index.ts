import express from 'express';

const app = express();
const PORT = parseInt(process.env.PORT || '5000', 10);

app.use(express.json());
app.use(express.urlencoded({ extended: false }));

app.get('/health', (req, res) => {
  res.json({
    status: 'healthy',
    timestamp: new Date().toISOString(),
    port: PORT,
    version: '7.0.0-ULTRA-FIX',
    environment: process.env.NODE_ENV || 'production'
  });
});

// Rota raiz ser√° definida ap√≥s registerRoutes

app.get('/demo-medico', (req, res) => {
  res.send(`<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Demo M√©dico - TeleMed Sistema v7.0.0</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      max-width: 650px;
      margin: 0 auto;
    }
    .version-badge {
      background: #9b2c2c;
      color: white;
      padding: 12px 24px;
      border-radius: 30px;
      font-size: 16px;
      font-weight: 800;
      margin-bottom: 25px;
      display: inline-block;
      animation: bounce 1s infinite;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    @keyframes bounce {
      0% { transform: scale(1); box-shadow: 0 4px 15px rgba(155, 44, 44, 0.3); }
      50% { transform: scale(1.1); box-shadow: 0 6px 25px rgba(155, 44, 44, 0.5); }
      100% { transform: scale(1); box-shadow: 0 4px 15px rgba(155, 44, 44, 0.3); }
    }
    
    h1 { color: #2d3748; text-align: center; margin-bottom: 2rem; font-size: 2.2rem; }
    
    .instant-demo {
      text-align: center;
      padding: 40px;
      background: linear-gradient(45deg, #4299e1, #48bb78);
      border-radius: 15px;
      color: white;
      margin-bottom: 30px;
    }
    
    .demo-info {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 12px;
      margin: 20px 0;
      border: 1px solid #e9ecef;
      text-align: left;
    }
    
    .access-box {
      background: #e6fffa;
      border: 3px solid #38b2ac;
      padding: 30px;
      border-radius: 15px;
      margin: 25px 0;
      text-align: left;
    }
    
    .btn-mega {
      background: #e53e3e;
      color: white;
      padding: 20px 40px;
      border: none;
      border-radius: 15px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      margin: 15px;
      text-decoration: none;
      display: inline-block;
      animation: pulse 2s infinite;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .btn-open {
      background: #4299e1;
      animation: none;
    }
    
    .highlight-mega {
      background: #fed7d7;
      border: 3px solid #e53e3e;
      padding: 20px;
      border-radius: 12px;
      color: #742a2a;
      font-weight: 700;
      margin: 15px 0;
      text-align: center;
      font-size: 18px;
    }
    
    code {
      background: #1a202c;
      color: #f7fafc;
      padding: 8px 15px;
      border-radius: 8px;
      font-weight: bold;
      font-family: 'Courier New', monospace;
      font-size: 16px;
    }
    
    .back-link {
      display: inline-block;
      color: #4299e1;
      text-decoration: none;
      margin-bottom: 25px;
      font-weight: 600;
      font-size: 0.95rem;
    }
    .back-link:hover { color: #3182ce; }
  </style>
</head>
<body>
  <div class="container">
    <div class="version-badge">v7.0.0 ULTRA-FIX</div>
    <a href="/" class="back-link">‚Üê Voltar √† p√°gina inicial</a>
    
    <h1>Demo M√©dico - Acesso Direto</h1>
    
    <div class="instant-demo">
      <h2 style="margin-bottom: 20px; font-size: 1.8rem;">üöÄ DEMO INSTANT√ÇNEO ATIVO</h2>
      <p style="font-size: 1.2rem; margin-bottom: 25px;">
        Formul√°rio eliminado - Acesso direto √† plataforma completa
      </p>
      
      <div class="demo-info">
        <strong style="color: #2d3748;">üë®‚Äç‚öïÔ∏è M√©dico Demo Ativo:</strong><br>
        <strong style="color: #2d3748;">Nome:</strong> Dr. Marcelo Paranagaba<br>
        <strong style="color: #2d3748;">CRM:</strong> 123456/SP<br>
        <strong style="color: #2d3748;">Especialidade:</strong> Ginecologia<br>
        <strong style="color: #2d3748;">Status:</strong> Pronto para demonstra√ß√£o
      </div>
    </div>
    
    <div class="highlight-mega">
      üéØ ELIMINAMOS O FORMUL√ÅRIO QUE TRAVAVA - ACESSO DIRETO √Ä PLATAFORMA
    </div>
    
    <div class="access-box">
      <h3 style="color: #2d3748; margin-bottom: 20px; font-size: 1.4rem;">üìã Como Acessar Agora</h3>
      <div style="line-height: 2;">
        <strong>Passo 1:</strong> Clique no bot√£o "ABRIR PLATAFORMA" abaixo<br>
        <strong>Passo 2:</strong> OU abra uma nova aba e digite: <code>localhost:5000</code><br>
        <strong>Passo 3:</strong> Entre como m√©dico demo e explore todas as funcionalidades<br><br>
        
        <div style="background: #ffd700; padding: 20px; border-radius: 10px; color: #744210; font-weight: 600; margin: 15px 0;">
          üí° PROBLEMA RESOLVIDO: Sem formul√°rios para travar - Acesso direto!<br>
          üåê Use o bot√£o VERDE se o vermelho n√£o funcionar<br><br>
          
          <strong>Se n√£o vir o bot√£o verde, copie este link:</strong><br>
          <code style="background: white; padding: 10px; display: block; margin-top: 10px; color: #2563eb; font-size: 14px;">
          https://telemed-consultation-daciobd.replit.app
          </code>
        </div>
      </div>
    </div>
    
    <div style="background: #f0f4ff; border: 2px solid #4299e1; padding: 25px; border-radius: 15px; margin: 25px 0; text-align: left;">
      <h3 style="color: #2d3748; margin-bottom: 15px;">üöÄ Funcionalidades para Testar</h3>
      <div style="line-height: 1.8;">
        ‚Ä¢ Videoconsultas WebRTC com chat em tempo real<br>
        ‚Ä¢ Prescri√ß√µes MEMED integradas (dados de teste prontos)<br>
        ‚Ä¢ Prontu√°rio eletr√¥nico completo com CID-10<br>
        ‚Ä¢ Pagamentos Stripe (cart√£o: 4242 4242 4242 4242)<br>
        ‚Ä¢ Assistente IA m√©dico com an√°lise de sintomas<br>
        ‚Ä¢ Dashboard m√©dico com 50+ pacientes simulados<br><br>
        
        <strong>‚è±Ô∏è Tempo de Demo:</strong> 30 minutos<br>
        <strong>üìö Documenta√ß√£o:</strong> GUIA_COMPLETO_MEDICOS.md
      </div>
    </div>
    
    <div style="text-align: center; margin-top: 40px;">
      <button onclick="abrirPlataformaPublica()" class="btn-mega">
        üöÄ ABRIR PLATAFORMA AGORA
      </button>
      
      <a href="https://telemed-consultation-daciobd.replit.app" target="_blank" class="btn-mega" style="background: #10b981; margin-left: 15px; font-size: 18px; padding: 20px 30px; border: 3px solid #059669;">
        üåê LINK DIRETO P√öBLICO
      </a>
      
      <a href="/" class="btn-mega btn-open">
        ‚Üê VOLTAR AO IN√çCIO
      </a>
    </div>
    
    <div style="background: #f0fff4; border: 2px solid #38b2ac; padding: 25px; border-radius: 12px; margin-top: 30px; text-align: center;">
      <strong style="color: #22543d; font-size: 16px;">
        ‚úÖ SOLU√á√ÉO DEFINITIVA: Acesso direto sem formul√°rios que podem travar
      </strong>
    </div>
  </div>
  
  <script>


    // Auto-salvar dados ao carregar a p√°gina
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üî• v7.0.0 ULTRA-FIX carregado - Sem formul√°rios HTML');
      
      const doctorData = {
        nome: "Dr. Marcelo Paranagaba", 
        crm: "123456/SP", 
        especialidade: "Ginecologia", 
        telefone: "(11) 99999-9999",
        timestamp: new Date().toISOString(),
        autoDemo: true
      };
      
      localStorage.setItem('demoDoctor', JSON.stringify(doctorData));
      console.log('‚úÖ Dados demo auto-salvos no localStorage');
    });
    
    // Fun√ß√£o espec√≠fica para URL p√∫blica do Replit
    function abrirPlataformaPublica() {
      console.log('üöÄ Abrindo plataforma via URL p√∫blica do Replit');
      
      // SEMPRE usar URL p√∫blica - nunca localhost
      const publicUrl = 'https://telemed-consultation-daciobd.replit.app';
      
      console.log('üåê URL de destino:', publicUrl);
      console.log('üîß For√ßando abertura em nova aba para evitar conflitos');
      
      // Sempre usar window.open em nova aba para evitar problemas de redirecionamento
      try {
        const newWindow = window.open(publicUrl, '_blank', 'noopener,noreferrer,width=1200,height=800');
        console.log('‚úÖ Nova aba aberta para:', publicUrl);
        
        if (!newWindow) {
          alert('Por favor, permita popups para este site e tente novamente.\\n\\nOu acesse diretamente: ' + publicUrl);
        }
      } catch (error) {
        console.error('‚ùå Erro ao abrir nova aba:', error);
        alert('Acesse diretamente: ' + publicUrl);
      }
    }
  </script>
</body>
</html>`);
});

app.get('/documentacao', (req, res) => {
  res.send(`<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Documenta√ß√£o - TeleMed Sistema</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8fafc;
      min-height: 100vh;
      line-height: 1.6;
      color: #2d3748;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 40px 20px;
    }
    h1 { color: #2d3748; margin-bottom: 2rem; text-align: center; font-size: 2.5rem; }
    .card {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 25px;
      border-left: 5px solid #4299e1;
    }
    .back-link {
      display: inline-block;
      color: #4299e1;
      text-decoration: none;
      margin-bottom: 25px;
      font-weight: 600;
    }
    .back-link:hover { color: #3182ce; }
  </style>
</head>
<body>
  <div class="container">
    <a href="/" class="back-link">‚Üê Voltar √† p√°gina inicial</a>
    
    <h1>üìö Documenta√ß√£o TeleMed Sistema v7.0.0</h1>
    
    <div class="card">
      <h2>üè• Sistema Completo de Telemedicina</h2>
      <p>Plataforma desenvolvida com React.js, Express.js, PostgreSQL e integra√ß√£o com Stripe, MEMED e WebRTC para oferecer uma solu√ß√£o completa de telemedicina.</p>
    </div>
    
    <div class="card">
      <h2>üöÄ Tecnologias Utilizadas</h2>
      <ul>
        <li><strong>Frontend:</strong> React.js com TypeScript, TailwindCSS</li>
        <li><strong>Backend:</strong> Express.js com TypeScript</li>
        <li><strong>Banco de Dados:</strong> PostgreSQL com Drizzle ORM</li>
        <li><strong>Pagamentos:</strong> Stripe</li>
        <li><strong>Prescri√ß√µes:</strong> MEMED</li>
        <li><strong>Videoconsultas:</strong> WebRTC</li>
      </ul>
    </div>
  </div>
</body>
</html>`);
});

// IMPORTAR TODAS AS ROTAS EXISTENTES
import { registerRoutes } from './routes.js';
import { createDeploymentHandler } from './deployment.js';

// Configurar autentica√ß√£o demo antes das rotas principais
app.get('/api/auth/demo-login', (req, res) => {
  // Simular login do m√©dico demo
  const demoUser = {
    id: 'demo_doctor_marcelo',
    email: 'marcelo@demo.com',
    firstName: 'Marcelo',
    lastName: 'Paranagaba',
    role: 'doctor',
    specialty: 'Ginecologia',
    licenseNumber: '123456/SP'
  };
  
  if (req.session) {
    req.session.userId = demoUser.id;
    req.session.user = demoUser;
  }
  
  res.json({ user: demoUser, message: 'Demo login successful' });
});

registerRoutes(app).then(httpServer => {
  // Adicionar rota raiz por √∫ltimo para garantir prioridade
  app.get('/', (req, res) => {
    res.send(`<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TeleMed Sistema - Plataforma de Telemedicina</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 0;
      padding: 40px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      text-align: center;
      max-width: 600px;
    }
    h1 {
      color: #2d3748;
      margin-bottom: 20px;
    }
    .btn {
      background: #3182ce;
      color: white;
      padding: 15px 30px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      margin: 10px;
      transition: all 0.3s;
    }
    .btn:hover {
      background: #2c5282;
      transform: translateY(-2px);
    }
    .btn-green {
      background: #38a169;
    }
    .btn-green:hover {
      background: #2f855a;
    }
    .solution {
      background: #e6fffa;
      border: 2px solid #38b2ac;
      padding: 25px;
      border-radius: 12px;
      margin: 25px 0;
      text-align: left;
    }
    .url-box {
      background: #f7fafc;
      border: 2px solid #4299e1;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      font-family: monospace;
      font-size: 14px;
      color: #2563eb;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ü©∫ TeleMed Sistema</h1>
    <p>Plataforma de Telemedicina Avan√ßada</p>
    
    <div class="solution">
      <strong>‚úÖ PROBLEMA RESOLVIDO!</strong><br>
      Sistema funcionando corretamente. Use o bot√£o verde abaixo para acessar a demonstra√ß√£o via URL p√∫blica.
    </div>
    
    <a href="/demo-medico" class="btn">
      üìã Demo Local
    </a>
    
    <a href="https://telemed-consultation-daciobd.replit.app/demo-medico" class="btn btn-green" target="_blank">
      üåê DEMO VIA URL P√öBLICA
    </a>
    
    <div class="url-box">
      Para colegas m√©dicos: https://telemed-consultation-daciobd.replit.app/demo-medico
    </div>
    
    <div style="margin-top: 30px; font-size: 14px; color: #666;">
      <p>v7.0.0-ULTRA-FIX | Sistema Corrigido</p>
    </div>
  </div>
</body>
</html>`);
  });

  const port = parseInt(PORT.toString(), 10);
  httpServer.listen(port, '0.0.0.0', () => {
    console.log(`üî• TeleMed v7.0.0-ULTRA-FIX - SEM FORMUL√ÅRIOS HTML`);
    console.log(`ü©∫ TeleMed Sistema rodando na porta ${port}`);
    console.log(`üåê Acesse: http://localhost:${port}`);
    console.log(`üìã Demo: http://localhost:${port}/demo-medico`);
    console.log(`üíö Health: http://localhost:${port}/health`);
  });
}).catch(error => {
  console.error('‚ùå Erro ao inicializar servidor:', error);
  
  // Fallback: servidor simples se as rotas falharem
  const port = parseInt(PORT.toString(), 10);
  app.listen(port, '0.0.0.0', () => {
    console.log(`üî• TeleMed v7.0.0-ULTRA-FIX (Modo Fallback)`);
    console.log(`üåê Porta: ${port}`);
    console.log(`üë®‚Äç‚öïÔ∏è Demo: /demo-medico`);
  });
});