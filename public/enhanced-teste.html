<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Consulta Avan√ßada ‚Ä¢ TeleMed</title>
  <style>
    :root{
      --bg:#0f172a;            /* fundo v√≠deo */
      --panel:#ffffff;         /* pain√©is/brancos */
      --ink:#111827;           /* texto escuro */
      --muted:#6B7280;         /* texto fraco */
      --line:1px solid rgba(0,0,0,.08);
      --blue:#60a5fa;          /* bot√µes azuis */
      --blue-600:#3b82f6;
      --green:#22c55e;         /* status conectado */
      --amber:#f59e0b;         /* enviar p/ espera */
      --red:#ef4444;           /* encerrar */
      --shadow:0 10px 30px rgba(0,0,0,.16);
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f4f7fb;color:var(--ink)}
    .page{display:grid;grid-template-columns:1.25fr 1fr;grid-template-rows:auto 1fr;gap:0;height:100vh}
    /* ====== COLUNA V√çDEO ====== */
    .videoWrap{position:relative;background:var(--bg);display:flex;align-items:center;justify-content:center;grid-row:2}
    .room{color:#cbd5e1;text-align:center}
    .room .cam{font-size:44px}
    .badge{display:inline-flex;align-items:center;gap:6px;background:#0f172a;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:#d1d5db;font-size:12px}
    .uptime{position:absolute;top:14px;right:14px;background:#111827;color:#fff;padding:6px 10px;border-radius:10px;font-variant-numeric:tabular-nums}
    /* controles embaixo */
    .controls{position:absolute;left:50%;bottom:18px;transform:translateX(-50%);display:flex;gap:10px;background:rgba(15,23,42,.6);backdrop-filter:blur(4px);padding:10px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.08)}
    .control{width:42px;height:42px;border-radius:999px;border:1px solid rgba(255,255,255,.15);display:grid;place-items:center;color:#e5e7eb;cursor:pointer;transition:.15s}
    .control:hover{transform:translateY(-2px);background:rgba(255,255,255,.08)}
    .control.red{background:var(--red);border-color:var(--red);color:#fff}
    .control.amber{background:var(--amber);border-color:var(--amber);color:#111}
    .control.blue{background:#1f2937;border-color:#334155}
    .notif .dot{position:absolute;right:-2px;top:-2px;width:16px;height:16px;background:#ef4444;color:#fff;border-radius:999px;display:grid;place-items:center;font-size:11px;border:2px solid #0f172a}
    /* ====== COLUNA PAINEL ====== */
    .panel{background:#f8fafc;overflow:auto;grid-row:2}
    .topbar{position:sticky;top:0;background:#fff;border-bottom:var(--line);padding:12px 14px;z-index:2;grid-column:1 / 3;grid-row:1}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .pInfo{display:flex;gap:12px;align-items:center}
    .avatar{width:30px;height:30px;border-radius:50%;background:#e5e7eb;display:grid;place-items:center}
    .pill{padding:6px 10px;border-radius:999px;border:var(--line);background:#fff;font-size:12px}
    .status{display:flex;gap:10px;align-items:center}
    .status .state{display:inline-flex;gap:6px;align-items:center;background:#f1f5f9;padding:6px 10px;border-radius:999px;border:var(--line);font-size:12px}
    .state .dot{width:8px;height:8px;border-radius:999px;background:#94a3b8}
    .state.wait .dot{background:#f59e0b}
    .state.live .dot{background:#22c55e}
    .btn{display:inline-flex;gap:8px;align-items:center;border:1px solid transparent;border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer}
    .btn.primary{background:var(--blue);color:#fff}
    .btn.primary:hover{background:var(--blue-600)}
    .btn.ghost{background:#fff;border:var(--line)}
    .tabs{display:flex;gap:6px;border-bottom:var(--line);background:#fff}
    .tab{padding:10px 12px;cursor:pointer;border-bottom:2px solid transparent}
    .tab.active{border-color:var(--blue);color:#0f172a;font-weight:600}
    .pad{padding:16px}
    .field{margin-bottom:14px}
    .label{font-size:13px;color:#374151;margin:0 0 6px;display:flex;gap:6px;align-items:center}
    .label .req{color:#ef4444}
    .inp, .area, .select{width:100%;border:var(--line);border-radius:10px;padding:10px 12px;background:#fff}
    .area{min-height:88px;resize:vertical}
    .segRow{display:flex;gap:8px;background:#f3f4f6;border-radius:10px;border:var(--line);overflow:hidden}
    .seg{flex:1;text-align:center;padding:8px 10px;cursor:pointer}
    .seg.active{background:#fff;border-bottom:2px solid var(--blue);font-weight:600}
    .chips{display:flex;gap:10px;flex-wrap:wrap}
    .switch{display:flex;gap:10px;align-items:center}
    .switch input{appearance:none;width:42px;height:24px;background:#e5e7eb;border-radius:999px;position:relative;outline:none;cursor:pointer;border:1px solid rgba(0,0,0,.08)}
    .switch input:checked{background:#bbf7d0}
    .switch input:before{content:"";position:absolute;left:3px;top:3px;width:18px;height:18px;border-radius:999px;background:#fff;transition:.18s}
    .switch input:checked:before{left:21px}
    .actions{display:flex;gap:12px;justify-content:flex-end;position:sticky;bottom:0;background:#fff;padding:12px 14px;border-top:var(--line)}
    .warn{background:#fff7ed;border:1px solid #fed7aa;color:#92400e;border-radius:8px;padding:8px 10px;margin-top:10px;font-size:13px}
    /* Exames */
    .templates{display:flex;flex-direction:column;gap:8px;border:var(--line);padding:10px;border-radius:10px;background:#fff;max-height:160px;overflow:auto}
    .tpl{padding:8px;border-radius:10px;border:1px dashed rgba(0,0,0,.1);cursor:pointer}
    .tpl:hover{background:#f8fafc}
    .examList{border:var(--line);border-radius:10px;background:#fff;min-height:90px;padding:12px;color:#475569}
    /* Memed */
    .memedCard{border:var(--line);border-radius:12px;background:#fff;padding:16px}
    .memedHead{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .ok{color:#16a34a}
    /* Dr AI Panel */
    .ai-panel{position:fixed;right:20px;bottom:20px;width:420px;max-height:72vh;display:none;flex-direction:column;background:#fff;border-radius:12px;box-shadow:var(--shadow);border:var(--line);overflow:hidden;z-index:9999}
    .ai-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:var(--line);background:#F8FAFF}
    .ai-disclaimer{padding:10px 14px;font-size:12px;color:#6B7280;background:#FBFDFF}
    .ai-thread{flex:1;padding:14px;overflow:auto;background:#FAFBFF}
    .ai-msg{display:flex;gap:8px;margin-bottom:12px}
    .ai-msg.assistant .bubble{background:#EEF6FF;border:1px solid rgba(162,210,255,.6)}
    .ai-msg.user .bubble{background:#F1F5F9;border:var(--line)}
    .bubble{padding:10px 12px;border-radius:12px;max-width:85%}
    .ai-form{display:flex;gap:8px;padding:10px;border-top:var(--line);background:#fff}
    #ai-input{flex:1;resize:none;border:var(--line);border-radius:10px;padding:10px}
    .ai-send{background:#60a5fa;border:1px solid #60a5fa;border-radius:10px;padding:0 14px;cursor:pointer;font-weight:600;color:#fff}
    .ai-send:hover{background:#3b82f6}
    /* ==== Barra de Receitas ==== */
    .rxBar{
      display:flex; align-items:center; justify-content:space-between;
      background:#fff; border:var(--line); border-radius:10px;
      padding:10px 12px; margin:10px 0 14px; box-shadow:var(--shadow,0 0 0 rgba(0,0,0,0));
    }
    .rxLeft{display:flex; align-items:center; gap:10px}
    .rxCount{padding:4px 8px; border-radius:999px; background:#f1f5f9; border:var(--line); font-size:12px}
    .rxActions{display:flex; gap:8px}
    @media (max-width:980px){.page{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="page">
  <!-- topo full width -->
  <div class="topbar">
    <div class="row">
      <div class="pInfo">
        <div class="avatar">üë§</div>
        <div>
          <div><strong id="pName">Ana Costa Silva</strong> <span class="pill" id="pAge">32 anos</span></div>
          <div style="font-size:12px;color:#64748b">üìû <span id="pPhone">11987654321</span> ‚Ä¢ <span class="pill">Particular</span></div>
        </div>
        <button class="btn ghost" id="btn-invite" title="Enviar convite ao paciente">Convite</button>
      </div>
      <div class="status">
        <span class="state wait" id="state"><span class="dot"></span> Aguardando</span>
        <span class="pill" id="elapsed">23m 00s</span>
        <button class="btn primary" id="btn-start">Iniciar Consulta</button>
        <button class="btn ghost" id="btn-back">Voltar</button>
        <button class="btn ghost" id="btn-form">Formul√°rio</button>
        <button class="btn ghost" id="btn-narrow">Faixa ‚Üì/‚Üë</button>
        <button class="btn ghost" id="btn-exit">Sair</button>
        <div class="control blue notif" title="Notifica√ß√µes" id="btn-bell">üîî<span class="dot" id="bellDot" style="display:none">1</span></div>
      </div>
    </div>
  </div>

  <!-- ======== COLUNA V√çDEO ========= -->
  <section class="videoWrap">
    <div class="uptime" id="uptime">00:00</div>

    <div class="room">
      <div class="cam">üìπ</div>
      <div style="font-size:18px;margin-top:8px">Aguardando paciente‚Ä¶</div>
      <div style="margin-top:6px">A chamada ser√° iniciada quando o paciente entrar</div>
      <div style="margin-top:10px" class="badge"><span style="width:8px;height:8px;border-radius:999px;background:var(--green)"></span> Conectado</div>
      <div style="margin-top:6px;color:#9ca3af">Sala: <strong>#ABC123</strong></div>
    </div>

    <!-- bot√µes inferiores -->
    <div class="controls">
      <button class="control blue" id="btn-attach" title="Anexar arquivo">üìé</button>
      <input type="file" id="filepick" hidden />
      <button class="control blue" id="btn-shot" title="Capturar imagem">üì∏</button>
      <button class="control blue" id="btn-chat" title="Abrir chat">üí¨</button>
      <button class="control blue" id="btn-ai" title="Dr. AI ‚Äì Assistente cl√≠nico">üß†</button>
      <button class="control blue" id="btn-mic" title="Microfone on/off">üéôÔ∏è</button>
      <button class="control blue" id="btn-cam" title="V√≠deo on/off">üé•</button>
      <button class="control amber" id="btn-wait" title="Enviar para sala de espera">‚è≥</button>
      <button class="control red" id="btn-hang" title="Finalizar chamada">‚õî</button>
    </div>
  </section>

  <!-- ======== COLUNA PAINEL ========= -->
  <section class="panel">

    <!-- abas -->
    <div class="tabs">
      <div class="tab" data-tab="chat">üí¨ Chat</div>
      <div class="tab active" data-tab="care">ü©∫ Atendimento</div>
      <div class="tab" data-tab="exams">üß™ Exames</div>
      <div class="tab" data-tab="receitas">üßæ Receitas</div>
    </div>

    <!-- CHAT -->
    <div class="pad" id="tab-chat" hidden>
      <div id="chatBox" style="height:54vh;overflow:auto;border:var(--line);border-radius:10px;background:#fff;padding:10px">
        <div style="max-width:70%;background:#f1f5f9;border-radius:12px;padding:10px;margin-bottom:8px">Ol√°, doutor! Como est√°?</div>
      </div>
      <div style="margin-top:8px;display:flex;gap:6px">
        <input id="chatInput" class="inp" placeholder="Digite uma mensagem‚Ä¶" />
        <button id="chatSend" class="btn primary">Enviar</button>
      </div>
    </div>

    <!-- ATENDIMENTO -->
    <div class="pad" id="tab-care">
      <!-- Barra de Receitas -->
      <div class="rxBar" role="region" aria-label="Receitas do atendimento">
        <div class="rxLeft">
          <strong>üßæ Receitas</strong>
          <span class="rxCount"><span id="rxCount">0</span> item(s)</span>
        </div>
        <div class="rxActions">
          <a class="btn primary" id="rxMemedLink" href="#" target="_blank" rel="noopener">Abrir Memed</a>
          <button class="btn ghost" id="rxScroll" type="button">Ver lista</button>
        </div>
      </div>
      
      <div class="field">
        <label class="label req">Queixa principal <span class="req">*</span></label>
        <input class="inp area" name="chief_complaint" placeholder="Dor de cabe√ßa intensa h√° 3 dias" required />
      </div>
      <div class="field">
        <label class="label req">Hist√≥ria da doen√ßa atual <span class="req">*</span></label>
        <textarea class="area" name="hpi" placeholder="Paciente refere..." required></textarea>
      </div>
      <div class="field">
        <label class="label req">Hip√≥tese diagn√≥stica <span class="req">*</span></label>
        <input class="inp" id="dx" name="dx" list="cid10" placeholder="Busque por CID-10 (ex: 'transtorno ansioso')" required />
        <datalist id="cid10"></datalist>
      </div>
      <div class="field">
        <label class="label req">Conduta terap√™utica <span class="req">*</span></label>
        <textarea class="area" name="plan" placeholder="Conduta: ..." required></textarea>
      </div>
      <div class="field">
        <label class="label">Sinais de alerta</label>
        <input class="inp" name="red_flags" placeholder="Dor tor√°cica, idea√ß√£o suicida, etc." />
      </div>
      <div class="field">
        <label class="label">Complexidade/Gravidade</label>
        <div class="chips">
          <label class="switch"><input type="checkbox" id="cmp1" /> Mental</label>
          <label class="switch"><input type="checkbox" id="cmp2" /> Cl√≠nica</label>
          <label class="switch"><input type="checkbox" id="cmp3" /> Inconsist√™ncia</label>
        </div>
      </div>
      <div class="segRow">
        <div class="seg active" data-seg="plan">Conduta</div>
        <div class="seg" data-seg="exams">Exames</div>
      </div>
      <div id="seg-plan">
        <!-- J√° coberto pelas caixas acima -->
      </div>
      <div id="seg-exams" hidden>
        <div style="margin-bottom:10px">
          <div style="font-weight:600;margin-bottom:8px">Templates comuns</div>
          <div class="templates" id="tplBox">
            <div class="tpl" data-name="Hemograma Completo" data-inst="Jejum de 8h">Hemograma Completo</div>
            <div class="tpl" data-name="Glicemia" data-inst="Jejum">Glicemia</div>
            <div class="tpl" data-name="Raio-X T√≥rax" data-inst="Sem joias">Raio-X T√≥rax</div>
            <div class="tpl" data-name="Eletrocardiograma" data-inst="Repouso">Eletrocardiograma</div>
          </div>
        </div>
        <div class="field">
          <label class="label">Nome do exame</label>
          <input class="inp" id="exName" placeholder="Hemograma completo" />
        </div>
        <div class="field">
          <label class="label">Prioridade</label>
          <select class="select" id="exPriority">
            <option>Rotina</option>
            <option>Priorit√°rio</option>
            <option>Urgente</option>
          </select>
        </div>
        <div class="field">
          <label class="label">Instru√ß√µes espec√≠ficas</label>
          <textarea class="area" id="exNotes" placeholder="Jejum de 8h, trazer documento..."></textarea>
        </div>
        <button class="btn primary" id="exAdd" style="width:100%">Adicionar Exame</button>
        <div style="margin-top:14px">
          <div style="font-weight:600;margin-bottom:8px">Exames Solicitados</div>
          <div class="examList" id="examList">Nenhum exame solicitado</div>
        </div>
      </div>
    </div>

    <!-- EXAMES -->
    <div class="pad" id="tab-exams" hidden>
      <!-- Mirror do seg-exams para aba completa -->
      <div id="examsMirror"></div>
    </div>

    <!-- RECEITAS -->
    <div class="pad" id="tab-receitas" hidden>
      <div class="memedCard">
        <div class="memedHead"><strong>üßæ Integra√ß√£o Memed</strong></div>
        <p>Prescreva medicamentos de forma segura e r√°pida com assinatura digital autom√°tica.</p>
        <button class="btn primary" id="memedBtn">Nova Receita Memed</button>
        <ul style="margin:12px 0 0 20px;font-size:14px;color:#374151">
          <li class="ok">Base farmacol√≥gica completa</li>
          <li class="ok">Assinatura digital ICP-Brasil</li>
          <li class="ok">Verifica√ß√£o de intera√ß√µes</li>
        </ul>
      </div>
      <div style="margin-top:14px">
        <div style="font-weight:600;margin-bottom:8px">Receitas do Atendimento</div>
        <div class="examList" id="rxList">Nenhuma receita ainda</div>
      </div>
    </div>

    <!-- A√ß√µes finais -->
    <div class="actions">
      <button class="btn ghost" id="btn-save">üíæ Salvar</button>
      <button class="btn primary" id="btn-finish">‚úÖ Finalizar Consulta</button>
    </div>
  </section>
</div>

<!-- ===== Dr. AI Panel ===== -->
<div id="dr-ai" class="ai-panel">
  <header class="ai-header">
    <div style="font-weight:700">üß† Dr. AI</div>
    <button id="ai-close" class="btn ghost">‚úï</button>
  </header>
  <div class="ai-disclaimer">
    As respostas s√£o apoio √† decis√£o e <b>n√£o substituem</b> o julgamento do m√©dico.
  </div>
  <div id="ai-thread" class="ai-thread"></div>
  <form id="ai-form" class="ai-form">
    <textarea id="ai-input" rows="2" placeholder="Digite sua pergunta cl√≠nica‚Ä¶"></textarea>
    <button class="ai-send" type="submit">Enviar</button>
  </form>
</div>
<!-- ===== /Dr. AI Panel ===== -->

<script>
/** ========= CONFIG (troque se quiser) ========= */
const API = {
  start  : (id)=> `/api/consults/${id}/start`,
  notes  : (id)=> `/api/consults/${id}/notes`,
  finish : (id)=> `/api/consults/${id}/finalize`,
  cid10  : (q)=> `/api/cid10/search?q=${encodeURIComponent(q)}`,
  aiAsk  : '/api/ai/ask'
};
const CONSULT_ID = new URLSearchParams(location.search).get('consultId') || 'demo-123';

/** ========= util ========= */
const $ = (s,root=document)=> root.querySelector(s);
const $$= (s,root=document)=> [...root.querySelectorAll(s)];
const post= async (url, body)=> {
  const r = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})});
  if(!r.ok) throw new Error('HTTP '+r.status);
  return r.json().catch(()=> ({}));
};

// Utilidades para receitas
function buildMemedURL(){
  const patient = {
    name:  $('#pName').textContent,
    age:   $('#pAge').textContent.replace(' anos',''),
    phone: $('#pPhone').textContent
  };
  // substitua pelo endpoint oficial quando integrar de fato
  return 'https://memed.com.br/?demo=1&patient='+encodeURIComponent(JSON.stringify(patient));
}
function updateRxCount(){
  const rxList = $('#rxList');
  const n = rxList ? rxList.children.length : 0;
  $('#rxCount').textContent = n;
}

/** ========= timer / uptime ========= */
let sec=780; // 13min j√° decorridos
setInterval(()=>{sec++; const m=String(Math.floor(sec/60)).padStart(2,'0'); const s=String(sec%60).padStart(2,'0'); $('#uptime').textContent=`${m}:${s}`; $('#elapsed').textContent = `${Math.floor(sec/60)}m ${s}s`;},1000);

/** ========= abas ========= */
$$('.tab').forEach(t=>t.addEventListener('click',()=>{
  $$('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  $('#tab-chat').hidden = t.dataset.tab!=='chat';
  $('#tab-care').hidden = t.dataset.tab!=='care';
  $('#tab-exams').hidden = t.dataset.tab!=='exams';
  $('#tab-receitas').hidden = t.dataset.tab!=='receitas';
}));

/** ========= segs (plan/exams) ========= */
$$('.seg').forEach(s=>s.addEventListener('click',()=>{
  $$('.seg').forEach(x=>x.classList.remove('active'));
  s.classList.add('active');
  $('#seg-plan').hidden  = s.dataset.seg!=='plan';
  $('#seg-exams').hidden = s.dataset.seg!=='exams';
}));

/** mirror da √°rea de exames na aba Exames */
$('#examsMirror').appendChild($('#seg-exams').cloneNode(true));

/** ========= bot√µes topo ========= */
$('#btn-invite').onclick = ()=>{ alert('Convite enviado para o paciente na sala de espera.'); };
$('#btn-start').onclick  = async ()=>{
  try{ await post(API.start(CONSULT_ID)); $('#state').classList.remove('wait'); $('#state').classList.add('live'); $('#state').innerHTML='<span class="dot"></span> Em atendimento'; }
  catch(e){ alert('Falha ao iniciar: '+e.message); }
};
$('#btn-back').onclick   = ()=> history.back();
$('#btn-form').onclick   = ()=> alert('Abrir formul√°rio de anamnese (WIP).');
$('#btn-narrow').onclick = ()=> document.body.classList.toggle('narrow');
$('#btn-exit').onclick   = ()=> { if(confirm('Sair desta tela?')) location.href='/'; };
$('#btn-bell').onclick   = ()=> $('#bellDot').style.display='none';

/** ========= barra de v√≠deo ========= */
$('#btn-attach').onclick = ()=> $('#filepick').click();
$('#filepick').onchange  = (e)=> { if(e.target.files[0]) { $('#bellDot').style.display='grid'; alert('Arquivo anexado: '+e.target.files[0].name); } };
$('#btn-shot').onclick   = ()=> alert('Captura de imagem (mock).');
$('#btn-chat').onclick   = ()=> { $('.tab[data-tab="chat"]').click(); };
$('#btn-mic').onclick    = (ev)=> ev.currentTarget.classList.toggle('red');
$('#btn-cam').onclick    = (ev)=> ev.currentTarget.classList.toggle('red');
$('#btn-wait').onclick   = ()=> alert('Paciente enviado para sala de espera.');
$('#btn-hang').onclick   = ()=> alert('Chamada finalizada.');

/** ========= chat simples ========= */
$('#chatSend').onclick = ()=>{
  const v = $('#chatInput').value.trim(); if(!v) return;
  $('#chatInput').value='';
  const b = document.createElement('div'); b.style.maxWidth='70%'; b.style.background='#3b82f6'; b.style.color='#fff'; b.style.borderRadius='12px'; b.style.padding='10px'; b.style.margin='8px 0 8px auto'; b.textContent=v;
  $('#chatBox').appendChild(b); $('#chatBox').scrollTop=$('#chatBox').scrollHeight;
};

/** ========= CID-10 autocomplete ========= */
let cidTimer=null;
$('#dx').addEventListener('input',()=>{
  clearTimeout(cidTimer);
  const q = $('#dx').value.trim();
  if(q.length<2) return;
  cidTimer = setTimeout(async ()=>{
    try{
      const r = await fetch(API.cid10(q));
      const list = await r.json(); // espera: [{code:"F41.1",name:"Transtorno..."}, ...]
      const dl = $('#cid10'); dl.innerHTML='';
      (list||[]).slice(0,30).forEach(it=>{
        const o=document.createElement('option'); o.value=`${it.code} - ${it.name}`; dl.appendChild(o);
      });
    }catch(e){}
  }, 200);
});

/** ========= salvar / finalizar ========= */
$('#btn-save').onclick = async ()=>{
  const payload = {
    chiefComplaint: $('[name="chief_complaint"]').value||'',
    hpi: $('[name="hpi"]').value||'',
    dx:  $('[name="dx"]').value||'',
    plan:$('[name="plan"]').value||'',
    redFlags:$('[name="red_flags"]').value||'',
    complexity:{
      mental: $('#cmp1').checked, clinical: $('#cmp2').checked, inconsistency: $('#cmp3').checked
    }
  };
  try{ await post(API.notes(CONSULT_ID), payload); alert('Anota√ß√µes salvas.'); }
  catch(e){ alert('Falha ao salvar: '+e.message); }
};
$('#btn-finish').onclick = async ()=>{
  try{ await post(API.finish(CONSULT_ID)); alert('Consulta finalizada.'); }
  catch(e){ alert('Falha ao finalizar: '+e.message); }
};

/** ========= Exames ========= */
const examList = [];
function renderExamList(){
  const box = $('#examList'); box.innerHTML='';
  if(!examList.length){ box.textContent='Nenhum exame solicitado'; return; }
  examList.forEach((ex,i)=>{
    const row=document.createElement('div');
    row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center';
    row.style.border='1px solid rgba(0,0,0,.06)'; row.style.padding='8px 10px'; row.style.borderRadius='8px'; row.style.margin='6px 0';
    row.innerHTML = `<div><b>${ex.name}</b> ‚Ä¢ ${ex.priority}<br><small>${ex.notes||''}</small></div><button data-i="${i}" class="btn ghost">Excluir</button>`;
    row.querySelector('button').onclick=(ev)=>{ examList.splice(Number(ev.target.dataset.i),1); renderExamList(); };
    box.appendChild(row);
  });
}
$('#exAdd').onclick = ()=>{
  const name=$('#exName').value.trim(); if(!name) return alert('Informe o nome do exame.');
  examList.push({name, priority:$('#exPriority').value, notes:$('#exNotes').value.trim()});
  $('#exName').value=''; $('#exNotes').value=''; renderExamList();
};
$('#tplBox').onclick = (ev)=>{
  const el = ev.target.closest('.tpl'); if(!el) return;
  $('#exName').value = el.dataset.name; $('#exNotes').value = el.dataset.inst;
};

/** ========= Memed ========= */
$('#memedBtn').onclick = ()=>{
  const patient = {name: $('#pName').textContent, age: $('#pAge').textContent.replace(' anos',''), phone: $('#pPhone').textContent};
  const url = 'https://memed.com.br/?demo=1&patient='+encodeURIComponent(JSON.stringify(patient));
  window.open(url, '_blank','noopener');
  // adiciona receita fict√≠cia na lista
  const li = document.createElement('div');
  li.style.padding='10px'; li.style.border='1px solid rgba(0,0,0,.06)'; li.style.borderRadius='10px'; li.style.margin='6px 0';
  li.innerHTML = `<b>Receita #MEMED-${Math.random().toString(36).slice(2,8).toUpperCase()}</b> <span style="color:#16a34a">‚úî Assinada</span><br><small>${new Date().toLocaleString()}</small><br><div style="margin-top:6px">Dipirona S√≥dica ‚Äì 500mg ‚Ä¢ 1 comprimido se dor ou febre</div>`;
  $('#rxList').appendChild(li);
  if($('#rxList').textContent.includes('Nenhuma')) $('#rxList').innerHTML='';
  updateRxCount();
};

/** ========= Dr. AI ========= */
function addMsg(role, txt){
  const row=document.createElement('div');
  row.className='ai-msg '+(role==='assistant'?'assistant':'user');
  row.innerHTML='<div class="bubble"></div>';
  row.querySelector('.bubble').textContent=txt;
  $('#ai-thread').appendChild(row);
  $('#ai-thread').scrollTop = $('#ai-thread').scrollHeight;
}
$('#btn-ai').onclick = ()=> { $('#dr-ai').style.display='flex'; };
$('#ai-close').onclick = ()=> { $('#dr-ai').style.display='none'; };
$('#ai-form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const q = $('#ai-input').value.trim(); if(!q) return;
  $('#ai-input').value=''; addMsg('user', q);
  const ctx = {
    chiefComplaint:$('[name="chief_complaint"]').value,
    hpi:$('[name="hpi"]').value, dx:$('[name="dx"]').value, redFlags:$('[name="red_flags"]').value
  };
  try{
    const r = await fetch(API.aiAsk,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({question:q, context:ctx})});
    const data = await r.json().catch(()=>({}));
    addMsg('assistant', data.answer || data.message || 'OK');
  }catch(err){ addMsg('assistant','‚ö†Ô∏è Erro ao consultar IA: '+err.message); }
});

// Barra de receitas
document.getElementById('rxMemedLink').onclick = (e) => {
  e.preventDefault();
  window.open(buildMemedURL(), '_blank', 'noopener');
  // opcional: focar a se√ß√£o de receitas
  document.querySelector('[data-tab="receitas"]').click();
};
document.getElementById('rxScroll').onclick = () => {
  document.querySelector('[data-tab="receitas"]').click();
  document.getElementById('tab-receitas').scrollIntoView({behavior:'smooth', block:'start'});
};

// Memed
document.getElementById('btn-memed').addEventListener('click', () => {
  window.open(buildMemedURL(), '_blank','noopener');

  // adiciona receita fict√≠cia na lista
  const li = document.createElement('div');
  li.style.padding='10px';
  li.style.border='1px solid rgba(0,0,0,.06)';
  li.style.borderRadius='10px';
  li.style.margin='6px 0';
  li.innerHTML = `<b>Receita #MEMED-${Math.random().toString(36).slice(2,8).toUpperCase()}</b>
                  <span style="color:#16a34a">‚úî Assinada</span><br>
                  <small>${new Date().toLocaleString()}</small><br>
                  <div style="margin-top:6px">Dipirona S√≥dica ‚Äì 500mg ‚Ä¢ 1 comprimido se dor ou febre</div>`;
  const rxList = document.getElementById('rxList');
  if(rxList.textContent.includes('Nenhuma')) rxList.innerHTML='';
  rxList.appendChild(li);
  updateRxCount();            // <<< atualiza o contador da barra
});

// Bot√µes de a√ß√£o
document.getElementById('btn-save').addEventListener('click', () => {
  alert('Dados salvos com sucesso!');
});

document.getElementById('btn-finish').addEventListener('click', () => {
  if (confirm('Deseja finalizar esta consulta?')) {
    alert('Consulta finalizada!');
  }
});

// Controles de v√≠deo
document.getElementById('btn-attach').addEventListener('click', () => {
  document.getElementById('filepick').click();
});

document.getElementById('btn-shot').addEventListener('click', () => {
  alert('Captura de tela realizada!');
});

document.getElementById('btn-chat').addEventListener('click', () => {
  // Ativar aba de chat
  document.querySelector('[data-tab="chat"]').click();
});

// Barra de receitas
$('#rxMemedLink').onclick = (e) => {
  e.preventDefault();
  window.open(buildMemedURL(), '_blank', 'noopener');
  // opcional: focar a se√ß√£o de receitas
  $('.tab[data-tab="receitas"]').click();
};
$('#rxScroll').onclick = () => {
  $('.tab[data-tab="receitas"]').click();
  $('#tab-receitas').scrollIntoView({behavior:'smooth', block:'start'});
};

console.log('üéØ Enhanced Teste loaded - TeleMed Professional Interface');
updateRxCount();
</script>
</body>
</html>