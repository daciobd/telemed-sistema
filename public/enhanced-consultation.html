<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Consulta Avançada • TeleMed</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0f172a; --panel:#111827; --ink:#e5e7eb; --muted:#9ca3af;
  --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444; --info:#3b82f6;
  --card:#0b1220; --card2:#0b1322; --ring:rgba(59,130,246,.35);
  --chip:#0b213d; --line:rgba(255,255,255,.08); --brand:#60a5fa;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;background:#0a0f1a;color:var(--ink)}
.app{display:flex; height:100vh; width:100vw; overflow:hidden}

/* ===== topo ===== */
.top{
  position:sticky; top:0; z-index:30;
  display:flex; align-items:center; justify-content:space-between;
  gap:12px; padding:10px 14px; background:#0b1322; border-bottom:1px solid var(--line)
}
.pinfo{display:flex; align-items:center; gap:10px}
.avatar{width:28px;height:28px;border-radius:999px;background:#1f2937;display:grid;place-items:center;font-weight:700}
.pmeta{display:flex; gap:12px; color:var(--muted); font-size:12px}
.badge{font-size:12px; padding:4px 8px; border-radius:999px; background:#0b213d; border:1px solid var(--line)}
.btn{display:inline-flex;align-items:center;gap:8px;padding:9px 12px;border-radius:10px;border:1px solid var(--line);cursor:pointer;background:#0e1629;color:var(--ink)}
.btn:hover{border-color:var(--ring)}
.btn.green{background:#0b2a16;border-color:#14532d;color:#86efac}
.btn.blue{background:#0b213d;border-color:#1e40af;color:#93c5fd}
.btn.red{background:#2a0b0b;border-color:#7f1d1d;color:#fca5a5}
.btn.yellow{background:#2a210b;border-color:#854d0e;color:#fde68a}
.stat{display:flex; align-items:center; gap:10px}
.dot{width:8px;height:8px;border-radius:999px;background:#22c55e;box-shadow:0 0 0 3px rgba(34,197,94,.15)}
.timer{font-variant-numeric:tabular-nums;color:var(--muted);font-size:12px}

/* ===== layout principal ===== */
.main{display:flex; flex:1; min-height:0}

/* vídeo à esquerda */
.left{flex:1.6; min-width:0; position:relative; background:radial-gradient(1200px 600px at -20% 120%, #091226, #0b1220)}
.wait{position:absolute; inset:0; display:grid; place-items:center; color:#cbd5e1}
.wait .cam{font-size:48px; opacity:.2}
.room{position:absolute; bottom:16px; left:18px; font-size:12px; color:#9ca3af}
.badgeOn{display:inline-flex;align-items:center;gap:6px;background:#052e16;color:#86efac;border:1px solid #14532d;padding:4px 8px;border-radius:999px}

/* cronômetro no canto */
.clock{position:absolute; top:14px; right:14px; background:#0b213d; padding:6px 10px; border-radius:10px; color:#cbd5e1; font-variant-numeric:tabular-nums}

/* toolbar inferior */
.toolbar{
  position:absolute; left:50%; bottom:16px; transform:translateX(-50%);
  display:flex; gap:12px; background:#0b1322; padding:10px 12px; border:1px solid var(--line); border-radius:999px
}
.ico{width:38px;height:38px;border-radius:999px;background:#0e1629;display:grid;place-items:center;cursor:pointer;border:1px solid var(--line)}
.ico:hover{border-color:var(--ring)}
.ico.red{background:#2a0b0b; color:#fecaca; border-color:#7f1d1d}
.ico.yellow{background:#2a210b; color:#fde68a; border-color:#854d0e}
.badge1{position:absolute; transform:translate(12px,-12px); background:#ef4444; color:white; font-size:10px; padding:2px 5px; border-radius:999px}

/* painel direito */
.right{
  width:480px; max-width:48vw; min-width:360px;
  border-left:1px solid var(--line); background:#0b1322; display:flex; flex-direction:column; min-height:0
}
.tabs{display:flex; gap:8px; padding:10px; border-bottom:1px solid var(--line)}
.tab{padding:8px 12px; border-radius:8px; background:#0e1629; color:#cbd5e1; cursor:pointer}
.tab.active{background:#0b213d; color:#93c5fd; border:1px solid #1e3a8a}
.pane{flex:1; overflow:auto; padding:12px}

/* chat */
.msgs{display:flex;flex-direction:column;gap:8px}
.bubble{max-width:70%; padding:10px 12px; border-radius:12px; background:#111827}
.bubble.me{margin-left:auto;background:#1d4ed8;color:white}
.chatin{display:flex; gap:8px; margin-top:10px}
.text{flex:1; padding:10px 12px; background:#0e1629; border:1px solid var(--line); border-radius:10px; color:var(--ink)}
.send{padding:0 14px}

/* atendimento (form) */
.form .row{margin-bottom:12px}
.label{font-size:12px; color:var(--muted); margin-bottom:6px}
.input, .textarea, .select{
  width:100%; padding:10px 12px; background:#0e1629; border:1px solid var(--line); border-radius:10px; color:var(--ink)
}
.textarea{min-height:80px; resize:vertical}
.req::after{content:" *"; color:#f87171}
.segment{display:flex; gap:8px; margin-bottom:10px}
.segtab{flex:1; padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:#0e1629; text-align:center; cursor:pointer}
.segtab.active{background:#0b213d; border-color:#1e40af; color:#93c5fd}
.switch{display:flex; align-items:center; gap:10px; margin:6px 0}
.sw{width:42px;height:22px;background:#0e1629;border:1px solid var(--line);border-radius:999px;position:relative;cursor:pointer}
.sw::after{content:"";position:absolute;top:2px;left:2px;width:18px;height:18px;border-radius:999px;background:#374151;transition:.15s}
.sw.on{background:#052e16;border-color:#14532d}
.sw.on::after{left:22px;background:#22c55e}
.actions{display:flex; gap:10px; margin-top:10px}

/* exames */
.card{background:#0e1629;border:1px solid var(--line);border-radius:10px;padding:12px}
.list{display:grid; gap:8px}
.add{background:#0b213d;border:1px solid #1e40af;color:#bfdbfe;padding:10px;border-radius:10px;cursor:pointer}
.empty{border:1px dashed var(--line); border-radius:10px; display:grid; place-items:center; padding:24px; color:var(--muted)}

/* receitas (Memed) */
.rxHead{display:flex; align-items:center; justify-content:space-between; gap:10px}
.rxBtn{background:#1d4ed8;color:white;border:none;padding:10px 14px;border-radius:10px;cursor:pointer}
.rxItem{background:#0e1629;border:1px solid var(--line);border-radius:10px;padding:10px 12px}
.kicker{font-size:12px;color:var(--muted)}

/* Dr.AI painel */
#aipanel{
  position:fixed; right:16px; bottom:16px; width:360px; max-width:90vw;
  background:#0b1322; border:1px solid var(--line); border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.35); display:none; flex-direction:column; z-index:50
}
.ahead{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--line)}
.acontent{padding:12px; max-height:45vh; overflow:auto; display:flex; flex-direction:column; gap:8px}
.afoot{display:flex; gap:8px; padding:12px; border-top:1px solid var(--line)}
.disclaimer{font-size:12px;color:#a3a3a3; padding:0 12px 8px}
.small{font-size:12px;color:var(--muted)}
.hidden{display:none}

/* util */
hr.sep{border:none;border-top:1px solid var(--line);margin:10px 0}

/* --- Patient banner overlay --- */
.patient-banner{
  position:absolute; inset:12px 12px auto 12px;
  display:flex; justify-content:space-between; align-items:center; gap:16px;
  padding:10px 12px; border-radius:12px;
  color:#E8F0FF; z-index:50;
  background:linear-gradient(90deg,rgba(7,13,28,.66),rgba(7,13,28,.42));
  border:1px solid rgba(162,210,255,.25);
  backdrop-filter: blur(6px);
  box-shadow: 0 6px 18px rgba(0,0,0,.25);
  pointer-events:auto;
}
.patient-banner .pb-left{display:flex;align-items:center;gap:12px;min-width:0}
.patient-banner .avatar{
  width:34px;height:34px;border-radius:10px;
  display:grid;place-items:center;background:#A2D2FF;color:#0F172A;font-weight:700;
}
.patient-banner .name{font-weight:700;letter-spacing:.1px}
.patient-banner .meta{opacity:.85;font-size:12px;white-space:nowrap}
.patient-banner .badge{
  background:rgba(162,210,255,.18);border:1px solid rgba(162,210,255,.4);
  color:#DCEBFF;border-radius:999px;padding:2px 8px;margin-right:6px
}
.patient-banner .sep{opacity:.5;margin:0 6px}
.patient-banner .pb-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.patient-banner .status-dot{
  width:10px;height:10px;border-radius:999px;display:inline-block;
  background: #22c55e; box-shadow:0 0 0 3px rgba(34,197,94,.18)
}
.patient-banner .status-dot.off{background:#ef4444; box-shadow:0 0 0 3px rgba(239,68,68,.18)}
.patient-banner .timer{font-variant-numeric:tabular-nums;opacity:.9;padding:0 4px}
.patient-banner .btn{
  display:inline-flex;align-items:center;gap:6px;
  padding:8px 12px;border-radius:10px;border:1px solid rgba(162,210,255,.32);
  background:rgba(12,18,32,.35); color:#E8F0FF; cursor:pointer; font-weight:600
}
.patient-banner .btn:hover{background:rgba(162,210,255,.12)}
.patient-banner .btn.pill{border-radius:999px;background:rgba(162,210,255,.15)}
.patient-banner .btn.start{background:#14a34a;border-color:#14a34a}
.patient-banner .btn.lite{background:transparent}
.patient-banner .btn.lite:hover{background:rgba(255,255,255,.06)}
@media (max-width: 980px){
  .patient-banner{inset:8px 8px auto 8px; gap:10px; padding:8px}
  .patient-banner .btn.lite{display:none} /* enxuga nos menores */
}

/* --- Split redimensionável --- */
.enh-split{
  display:grid;
  grid-template-columns: 1fr 6px minmax(380px, 36%);
  gap:0; height: calc(100vh - 80px); /* ajuste se seu topo for maior/menor */
}
.split-left, .split-right{min-width:0; min-height:0; overflow:auto}
.split-right{background:rgba(255,255,255,.02)}
.split-divider{
  cursor:col-resize; position:relative; background:linear-gradient(180deg,#152133,#0f172a);
  border-left:1px solid rgba(162,210,255,.08); border-right:1px solid rgba(162,210,255,.08);
}
.split-divider .grip{
  position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
  width:3px; height:36px; border-radius:2px; background:rgba(162,210,255,.35)
}
.split-divider.drag{background:#0f172a}
@media (max-width: 980px){
  .enh-split{grid-template-columns:1fr}
  .split-divider, .split-right{display:none} /* mobile: vira 1 coluna */
}
</style>
</head>
<body>
<div class="app">
  <!-- SPLIT layout -->
  <div class="enh-split" data-split="enhanced" id="splitRoot">
    <section id="leftPane" class="split-left" style="position:relative">
      <!-- === Patient Banner / Faixa sobre o vídeo === -->
      <div class="patient-banner" id="patientBanner" aria-live="polite">
        <div class="pb-left">
          <div class="avatar" id="pbAvatar">CF</div>
          <div class="id">
            <div class="name" id="pbName">Ana Costa Silva</div>
            <div class="meta">
              <span class="badge">Particular</span>
              <span class="sep">•</span>
              <span class="phone" id="pbPhone">11 98765-4321</span>
              <span class="sep">•</span>
              <span class="age" id="pbAge">0 anos</span>
            </div>
          </div>
          <button class="btn pill" id="btnInvite">Convite</button>
        </div>

        <div class="pb-right">
          <span class="status-dot on" id="pbStatusDot" aria-hidden="true"></span>
          <span class="status-label" id="statusLabel">Aguardando</span>
          <span class="timer" id="pbTimer">00:00</span>

          <button class="btn start" id="btnStart">▶ Iniciar Consulta</button>
          <button class="btn lite"  id="btnBack">Voltar</button>
          <button class="btn lite"  id="btnForm">Formulário</button>
          <button class="btn lite"  id="btnLeave">Sair</button>
        </div>
      </div>

      <!-- VÍDEO PRINCIPAL -->
      <div class="clock" id="clock">00:00</div>
      <div class="wait">
        <div>
          <div class="cam">📷</div>
          <div style="text-align:center;margin-top:8px;color:#9ca3af">Aguardando paciente…</div>
          <div class="room">
            <span class="badgeOn"><span style="width:8px;height:8px;border-radius:999px;background:#22c55e"></span>Conectado</span>
            <div style="margin-top:6px;color:#9ca3af">Sala: #ABC123</div>
          </div>
        </div>
      </div>

      <!-- barra inferior -->
      <div class="toolbar">
        <div class="ico" title="Anexar (arquivo)"><input id="fileup" type="file" multiple class="hidden"><span>📎</span></div>
        <div class="ico" id="btnShot" title="Captura de tela"><span>📷</span></div>
        <div class="ico" id="btnOpenChat" title="Abrir Chat"><span>💬</span></div>
        <div class="ico" id="btnBell" title="Notificações"><span>🔔</span><span class="badge1" id="bellN" style="display:none">1</span></div>
        <div class="ico" id="btnAI" title="Dr. AI (orientação)"><span>🧠</span></div>
        <div class="ico" id="btnMic" title="Mic on/off"><span>🎙️</span></div>
        <div class="ico" id="btnCam" title="Vídeo on/off"><span>🎥</span></div>
        <div class="ico yellow" id="btnHold" title="Enviar p/ sala de espera"><span>⏸️</span></div>
        <div class="ico red" id="btnEnd" title="Encerrar"><span>⛔</span></div>
      </div>
    </section>

    <!-- divisor arrastável -->
    <div id="divider" class="split-divider" role="separator"
         aria-orientation="vertical" aria-label="Redimensionar painel de anotações"
         tabindex="0">
      <span class="grip" aria-hidden="true"></span>
    </div>

    <aside id="rightPane" class="split-right">

      <!-- abas -->
      <div class="tabs">
        <div class="tab" data-tab="chat">💬 Chat</div>
        <div class="tab active" data-tab="care">🩺 Atendimento</div>
        <div class="tab" data-tab="exams">🧪 Exames</div>
        <div class="tab" data-tab="rx">💊 Receitas</div>
      </div>

      <!-- panes -->
      <div class="pane" id="pane-chat" style="display:none">
        <div class="msgs" id="msgs">
          <div class="bubble">Olá, doutor! Como está?</div>
          <div class="bubble me">Olá! Estou bem, obrigado. Como posso ajudá-lo hoje?</div>
          <div class="bubble">Sinto dores de cabeça frequentes…</div>
        </div>
        <div class="chatin">
          <input id="msg" class="text" placeholder="Digite sua mensagem…"/>
          <button class="btn send" id="send">Enviar</button>
        </div>
      </div>

      <div class="pane form" id="pane-care">
        <div class="row">
          <div class="label req">Queixa Principal</div>
          <textarea id="field-qp" class="textarea" placeholder="Motivo da consulta"></textarea>
        </div>
        <div class="row">
          <div class="label req">História da Doença Atual</div>
          <textarea id="field-hda" class="textarea" placeholder="Evolução dos sintomas"></textarea>
        </div>

        <div class="row">
          <div class="label req">Hipótese Diagnóstica / CID-10</div>
          <input id="cidInput" class="input" list="cidlist" placeholder="Digite CID">
          <datalist id="cidlist"></datalist>
        </div>

        <div class="segment">
          <div class="segtab active" data-seg="cond">Conduta</div>
          <div class="segtab" data-seg="exams">Exames</div>
          <div class="segtab" data-seg="memed">MedMed</div>
        </div>

        <div id="seg-cond">
          <div class="row">
            <div class="label req">Conduta Terapêutica</div>
            <textarea id="field-cond" class="textarea" placeholder="Orientações e tratamento"></textarea>
          </div>
          <div class="row">
            <div class="label">Complexidade</div>
            <div class="switch"><div class="sw" id="sw-grave"></div> Agravo em saúde mental</div>
            <div class="switch"><div class="sw" id="sw-compl"></div> Complexidade clínica</div>
            <div class="switch"><div class="sw" id="sw-inc"></div> Inconsistência de queixas</div>
          </div>
          <div class="row">
            <div class="label">Sinais de Alerta</div>
            <input id="field-alert" class="input" placeholder="Ex: ideação suicida, dor torácica…">
          </div>
          <div class="actions">
            <button class="btn blue" id="btnSave">💾 Salvar Atendimento</button>
            <button class="btn red" id="btnFinish">✔ Finalizar Consulta</button>
          </div>
        </div>

        <div id="seg-exams" class="hidden">
          <div class="card">
            <div class="label">Templates Comuns</div>
            <div class="list" id="tplList">
              <div class="rxItem" data-name="Hemograma completo" data-rotina="Jejum de 8–12 horas">Hemograma completo <div class="kicker">Jejum de 8–12 horas</div></div>
              <div class="rxItem" data-name="Glicemia de jejum" data-rotina="Jejum rigoroso de 8–12 horas">Glicemia de jejum <div class="kicker">Jejum rigoroso de 8–12 horas</div></div>
            </div>
          </div>
          <div class="row"><div class="label">Nome do exame</div><input id="ex-name" class="input"></div>
          <div class="row"><div class="label">Rotina</div>
            <select id="ex-prio" class="select">
              <option>Rotina</option><option>Prioritário</option><option>Urgente</option>
            </select>
          </div>
          <div class="row"><div class="label">Instruções específicas</div><textarea id="ex-notes" class="textarea"></textarea></div>
          <button class="add" id="addExam">+ Adicionar Exame</button>
          <div class="row">
            <div class="label">Solicitações</div>
            <div id="examList" class="empty">Nenhum exame solicitado</div>
          </div>
        </div>

        <div id="seg-memed" class="hidden">
          <div class="card">
            <div class="rxHead">
              <div>
                <div style="font-weight:600">Integração MedMed</div>
                <div class="kicker">Base farmacológica, assinatura digital ICP-Brasil, verificação de interações.</div>
              </div>
              <button class="rxBtn" id="openMemed">Nova Receita MedMed</button>
            </div>
          </div>
          <div class="row">
            <div class="label">Receitas do Atendimento</div>
            <div id="rxList" class="empty">Nenhuma receita ainda</div>
          </div>
        </div>
      </div>

      <div class="pane" id="pane-exams" style="display:none">
        <div class="card">
          <div class="label">Atalho</div>
          <div class="kicker">Use a aba "Atendimento → MedMed" para prescrever.</div>
        </div>
      </div>

      <div class="pane" id="pane-rx" style="display:none">
        <div class="card">
          <div class="rxHead">
            <div>
              <div style="font-weight:600">Integração MedMed</div>
              <div class="kicker">Clique abaixo para abrir a prescrição em nova aba.</div>
            </div>
            <button class="rxBtn" id="openMemed2">Nova Receita MedMed</button>
          </div>
        </div>
        <div class="row"><div class="label">Receitas do Atendimento</div><div id="rxList2" class="empty">Nenhuma receita ainda</div></div>
      </div>
    </section>
  </div>
</div>

<!-- Painel Dr.AI -->
<div id="aipanel">
  <div class="ahead"><div>🧠 <b>Dr. AI</b></div><button class="btn red" id="aiClose">Fechar</button></div>
  <div class="disclaimer">As respostas são apoio à decisão e <b>não substituem</b> o julgamento clínico.</div>
  <div class="acontent" id="aiMsgs">
    <div class="bubble">Como posso ajudar?</div>
  </div>
  <div class="afoot">
    <input id="aiText" class="text" placeholder="Digite sua pergunta clínica…">
    <button class="btn blue" id="aiSend">Enviar</button>
  </div>
</div>

<script>
/* ===== util ===== */
const $ = (q) => document.querySelector(q);
const $$ = (q) => Array.from(document.querySelectorAll(q));
const toast = (t) => { console.log('TOAST:', t); };

/* ===== timer ===== */
let secs = 0;
setInterval(()=>{ secs++; const m=String(Math.floor(secs/60)).padStart(2,'0'); const s=String(secs%60).padStart(2,'0'); $('#clock').textContent=`${m}:${s}` }, 1000);

/* ===== topo: ações ===== */
const btnBack = $('#btnBack');
const btnExit = $('#btnExit');
const btnToggleForm = $('#btnToggleForm');
const btnW = $('#btnW');

if(btnBack) btnBack.onclick = () => history.back();
if(btnExit) btnExit.onclick = () => location.href = '/';

let formVisible = true;
if(btnToggleForm) {
  btnToggleForm.onclick = () => {
    const rp = $('#rightPane');
    formVisible = !formVisible;
    if(rp) rp.style.display = formVisible ? 'flex' : 'none';
  };
}

let widths = [360, 480, 640], wi=1;
if(btnW) {
  btnW.onclick = () => {
    wi = (wi+1)%widths.length;
    const w = widths[wi];
    const rp = $('#rightPane');
    if(rp) rp.style.width = w+'px';
  };
}

/* ===== tabs ===== */
function setTab(name){
  $$('.tab').forEach(el => el.classList.toggle('active', el.dataset.tab===name));
  $('#pane-chat').style.display   = name==='chat'?'block':'none';
  $('#pane-care').style.display   = name==='care'?'block':'none';
  $('#pane-exams').style.display  = name==='exams'?'block':'none';
  $('#pane-rx').style.display     = name==='rx'?'block':'none';
}
$$('.tab').forEach(el => el.onclick = () => setTab(el.dataset.tab));

/* ===== segment (conduta/exames/memed dentro do atendimento) ===== */
function setSeg(id){
  $$('.segtab').forEach(s=>s.classList.toggle('active', s.dataset.seg===id));
  $('#seg-cond').classList.toggle('hidden', id!=='cond');
  $('#seg-exams').classList.toggle('hidden', id!=='exams');
  $('#seg-memed').classList.toggle('hidden', id!=='memed');
}
$$('.segtab').forEach(s => s.onclick = () => setSeg(s.dataset.seg));

/* ===== switches ===== */
$$('.sw').forEach(sw => sw.onclick = () => sw.classList.toggle('on'));

/* ===== CID10 autosuggest ===== */
const localCid = [
  "F41.1 – Transtorno de ansiedade generalizada",
  "G43.0 – Enxaqueca sem aura",
  "J00 – Nasofaringite aguda (resfriado)",
  "I10 – Hipertensão essencial (primária)",
  "E11 – Diabetes mellitus tipo 2"
];
async function loadCid(q){
  try{
    const r = await fetch(`/api/cid10?q=${encodeURIComponent(q)}`);
    if(!r.ok) throw 0;
    const list = await r.json();
    return list.length? list : localCid.filter(x => x.toLowerCase().includes(q.toLowerCase()));
  }catch{ return localCid.filter(x => x.toLowerCase().includes(q.toLowerCase())); }
}
$('#cidInput').addEventListener('input', async e => {
  const q = e.target.value.trim(); if(q.length<2) return;
  const opts = await loadCid(q);
  const dl = $('#cidlist'); dl.innerHTML='';
  opts.slice(0,50).forEach(x => {
    const o = document.createElement('option'); o.value=x; dl.appendChild(o);
  });
});

/* ===== exames ===== */
const examStore = [];
function renderExams(){
  const wrap = $('#examList');
  if(!examStore.length){ wrap.className='empty'; wrap.textContent='Nenhum exame solicitado'; return; }
  wrap.className='list';
  wrap.innerHTML='';
  examStore.forEach((e,i)=>{
    const d = document.createElement('div');
    d.className='rxItem';
    d.innerHTML = `<b>${e.name}</b> <div class="kicker">${e.prio}${e.notes?` • ${e.notes}`:''}</div>`;
    wrap.appendChild(d);
  });
}
$('#tplList').addEventListener('click', e=>{
  const el = e.target.closest('.rxItem'); if(!el) return;
  $('#ex-name').value = el.dataset.name;
  $('#ex-notes').value = el.dataset.rotina;
});
$('#addExam').onclick = ()=>{
  const name = $('#ex-name').value.trim(); if(!name) return;
  const prio = $('#ex-prio').value;
  const notes = $('#ex-notes').value.trim();
  examStore.push({name, prio, notes});
  renderExams(); $('#ex-name').value=''; $('#ex-notes').value='';
};

/* ===== Memed ===== */
function patientDemo(){
  return { name:"Ana Costa Silva", age:"0", phone:"11987654321" }
}
function memedUrl(){
  const p = patientDemo();
  return `https://memed.com.br/?demo=1&patient=${encodeURIComponent(JSON.stringify(p))}`;
}
const rxStore = JSON.parse(localStorage.getItem('telemed_rx')||'[]');
function saveRx(){ localStorage.setItem('telemed_rx', JSON.stringify(rxStore)); }
function renderRx(){
  const containers = [$('#rxList'), $('#rxList2')].filter(Boolean);
  containers.forEach(wrap=>{
    if(!rxStore.length){ wrap.className='empty'; wrap.textContent='Nenhuma receita ainda'; return; }
    wrap.className='list'; wrap.innerHTML='';
    rxStore.forEach(r=>{
      const d = document.createElement('div');
      d.className='rxItem';
      d.innerHTML = `<div><b>Receita #${r.code}</b> <span class="badge">Assinada</span></div>
                     <div class="kicker">${r.drug} • ${r.sig}</div>`;
      wrap.appendChild(d);
    });
  });
}
function addDemoRx(){
  const code = Math.random().toString(36).slice(2,9).toUpperCase();
  rxStore.unshift({code, drug:"Dipirona sódica 500 mg", sig:"1 comprimido se dor ou febre • 20 cp"});
  saveRx(); renderRx();
}
const openMemed = $('#openMemed');
const openMemed2 = $('#openMemed2');
if(openMemed) openMemed.onclick = ()=>{ window.open(memedUrl(), '_blank'); setTimeout(addDemoRx, 1200); };
if(openMemed2) openMemed2.onclick = ()=>{ window.open(memedUrl(), '_blank'); setTimeout(addDemoRx, 1200); };
renderRx();

/* ===== Chat simples ===== */
const sendBtn = $('#send');
if(sendBtn) {
  sendBtn.onclick = ()=>{
    const msgInput = $('#msg');
    const msgsContainer = $('#msgs');
    if(!msgInput || !msgsContainer) return;
    const v = msgInput.value.trim(); if(!v) return;
    const b = document.createElement('div'); b.className='bubble me'; b.textContent=v; 
    msgsContainer.appendChild(b); msgInput.value='';
    msgsContainer.scrollTop = 1e9;
  };
}

/* ===== Dr.AI ===== */
const aiPanel = $('#aipanel');
function toggleAI(show){ if(aiPanel) aiPanel.style.display = show?'flex':'none'; }
const btnAI = $('#btnAI');
const aiClose = $('#aiClose');
const aiSend = $('#aiSend');
const aiText = $('#aiText');
const aiMsgs = $('#aiMsgs');

if(btnAI) btnAI.onclick = ()=> toggleAI(true);
if(aiClose) aiClose.onclick = ()=> toggleAI(false);
if(aiSend) {
  aiSend.onclick = async ()=>{
    if(!aiText || !aiMsgs) return;
    const t = aiText.value.trim(); if(!t) return;
    const add = (txt, me)=>{ const d=document.createElement('div'); d.className='bubble'+(me?' me':''); d.textContent=txt; aiMsgs.appendChild(d); aiMsgs.scrollTop=1e9; };
    add(t, true); aiText.value='';
    try{
      const r = await fetch('/api/ai/doctor', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({message:t, page:'enhanced'})});
      if(!r.ok) throw 0; const j = await r.json(); add(j.answer || 'OK');
    }catch{ add('Sugestão: confirmar sinais de alarme, avaliar necessidade de exame físico e medir PA.'); }
  };
}

/* ===== topo: start/save/finalize/invite ===== */
const btnStart = $('#btnStart');
const btnSave = $('#btnSave');
const btnFinish = $('#btnFinish');
const btnInvite = $('#btnInvite');

if(btnStart) {
  btnStart.onclick = async ()=>{
    try{ await fetch('/api/consults/ABC123/start',{method:'POST'}); }catch{}
    const sinceEl = $('#since');
    if(sinceEl) sinceEl.textContent='Em atendimento';
    toast('Consulta iniciada');
  };
}

if(btnSave) {
  btnSave.onclick = async ()=>{
    const payload = {
      qp: $('#field-qp')?.value || '',
      hda: $('#field-hda')?.value || '',
      cid: $('#cidInput')?.value || '',
      cond: $('#field-cond')?.value || '',
      alert: $('#field-alert')?.value || '',
      flags: {
        grave: $('#sw-grave')?.classList.contains('on') || false,
        compl: $('#sw-compl')?.classList.contains('on') || false,
        inc: $('#sw-inc')?.classList.contains('on') || false
      },
      exams: examStore,
      rx: rxStore
    };
    try{ await fetch('/api/consults/ABC123/notes',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});}catch{}
    toast('Atendimento salvo');
  };
}

if(btnFinish) {
  btnFinish.onclick = async ()=>{
    try{ await fetch('/api/consults/ABC123/finalize',{method:'POST'});}catch{}
    alert('Consulta finalizada!');
  };
}

if(btnInvite) {
  btnInvite.onclick = async ()=>{
    try{ await fetch('/api/consults/ABC123/invite',{method:'POST'});}catch{}
    const b = $('#bellN'); 
    if(b) b.style.display='inline-block';
    toast('Convite enviado para a sala de espera');
  };
}

/* ===== barra vídeo ===== */
const btnOpenChat = $('#btnOpenChat');
const btnShot = $('#btnShot');
const btnMic = $('#btnMic');
const btnCam = $('#btnCam');
const btnHold = $('#btnHold');
const btnEnd = $('#btnEnd');

if(btnOpenChat) btnOpenChat.onclick = ()=> setTab('chat');
if(btnShot) btnShot.onclick = ()=> toast('Screenshot salvo (demo)');

let micOn=true, camOn=true;
if(btnMic) btnMic.onclick = ()=>{ micOn=!micOn; btnMic.style.opacity = micOn?1:.5; };
if(btnCam) btnCam.onclick = ()=>{ camOn=!camOn; btnCam.style.opacity = camOn?1:.5; };
if(btnHold) btnHold.onclick = ()=>{ const sinceEl = $('#since'); if(sinceEl) sinceEl.textContent='Em espera'; toast('Paciente enviado à sala de espera (demo)'); };
if(btnEnd) btnEnd.onclick = ()=>{ if(confirm('Encerrar a chamada?')) toast('Chamada encerrada (demo)'); };
</script>

<!-- Analytics Module -->
<script src="/js/telemed-analytics.js"></script>

<!-- Banner profissional do paciente e sistema de redimensionamento -->
<script>
(() => {
  // timer simples
  const timerEl = document.getElementById('pbTimer');
  let secs = 0, t;
  function startTimer(){
    clearInterval(t);
    t = setInterval(() => {
      secs++;
      const m = String(Math.floor(secs/60)).padStart(2,'0');
      const s = String(secs%60).padStart(2,'0');
      timerEl.textContent = `${m}:${s}`;
    }, 1000);
  }

  // IDs de exemplo (substitua pelo que usa no seu router)
  const consultId = new URLSearchParams(location.search).get('id') || 'demo';

  // Botões do banner
  document.getElementById('btnInvite')?.addEventListener('click', async () => {
    try {
      await fetch(`/api/consults/${consultId}/invite`, {method:'POST'});
      alert('Convite enviado ao paciente na sala de espera.');
    } catch { alert('Falha ao enviar convite.'); }
  });

  document.getElementById('btnStart')?.addEventListener('click', async () => {
    try {
      const r = await fetch(`/api/consults/${consultId}/start`, {method:'POST'});
      if(r.ok){
        document.getElementById('statusLabel').textContent = 'Em atendimento';
        document.getElementById('pbStatusDot').classList.remove('off');
        startTimer();
      } else { throw new Error(); }
    } catch { alert('Não foi possível iniciar a consulta.'); }
  });

  document.getElementById('btnBack')?.addEventListener('click', () => history.back());
  document.getElementById('btnForm')?.addEventListener('click', () => {
    // abra seu drawer/modal de anamnese aqui
    document.querySelector('[data-pane="anamnese"]')?.classList.toggle('open');
  });
  document.getElementById('btnLeave')?.addEventListener('click', () => {
    if(confirm('Encerrar e sair desta consulta?')) location.href = '/';
  });
})();

(() => {
  // Sistema de redimensionamento
  const root   = document.getElementById('splitRoot');
  const right  = document.getElementById('rightPane');
  const divider= document.getElementById('divider');
  if(!root || !right || !divider) return;

  const KEY = 'enhanced.rightWidth';
  const MIN = 320, MAX = 760;   // limites da coluna direita
  const BAR = 6;                // largura do divisor

  // aplica largura persistida
  const saved = parseInt(localStorage.getItem(KEY)||'0',10);
  if(saved) root.style.gridTemplateColumns = `1fr ${BAR}px ${saved}px`;

  let startX = 0, startW = 0, dragging = false;
  function setRight(px){
    const total = root.clientWidth;
    const clamped = Math.max(MIN, Math.min(MAX, px, total - 320)); // garante mínimo da esquerda
    root.style.gridTemplateColumns = `1fr ${BAR}px ${clamped}px`;
    localStorage.setItem(KEY, String(clamped));
  }

  divider.addEventListener('pointerdown', (e) => {
    dragging = true; divider.classList.add('drag');
    startX = e.clientX; startW = right.getBoundingClientRect().width;
    divider.setPointerCapture(e.pointerId);
  });
  divider.addEventListener('pointermove', (e) => {
    if(!dragging) return;
    const delta = e.clientX - startX;
    setRight(startW - delta); // mover à direita diminui; à esquerda aumenta
  });
  function endDrag(){ dragging=false; divider.classList.remove('drag'); }
  divider.addEventListener('pointerup', endDrag);
  divider.addEventListener('pointercancel', endDrag);
  divider.addEventListener('dblclick', () => setRight(460));

  // acessibilidade pelo teclado
  divider.addEventListener('keydown', (e) => {
    if(e.key === 'ArrowLeft'){ setRight((right.getBoundingClientRect().width||460)+24); }
    if(e.key === 'ArrowRight'){ setRight((right.getBoundingClientRect().width||460)-24); }
    if(e.key === 'Enter'){ setRight(460); }
  });
})();
</script>

<!-- Analytics Integration -->
<script>
(() => {
  const ta = window.telemedAnalytics;
  if (!ta) return;

  // Configuração da consulta
  const params = new URLSearchParams(location.search);
  const consultId = params.get('cid') || 'enhanced-demo';
  const patientId = params.get('pid') || 'demo-patient';

  // === Eventos do Banner Profissional ===
  document.getElementById('btnInvite')?.addEventListener('click', () => {
    ta.track('invite_clicked', { consultId, patientId, source: 'banner' });
  });

  document.getElementById('btnStart')?.addEventListener('click', () => {
    ta.track('consult_start', { consultId, action: 'banner_start' });
  });

  document.getElementById('btnBack')?.addEventListener('click', () => {
    ta.track('navigation_back', { consultId, source: 'banner' });
  });

  document.getElementById('btnForm')?.addEventListener('click', () => {
    ta.track('form_toggle', { consultId, source: 'banner' });
  });

  document.getElementById('btnLeave')?.addEventListener('click', () => {
    ta.track('consult_leave', { consultId, source: 'banner' });
  });

  // === Eventos das Abas ===
  document.querySelectorAll('[data-tab]').forEach(el => {
    el.addEventListener('click', () => {
      ta.track('tab_change', { 
        tab: el.dataset.tab, 
        consultId,
        tabText: el.textContent?.trim()
      });
    });
  });

  // === Eventos dos Segmentos (Conduta/Exames/MedMed) ===
  document.querySelectorAll('[data-seg]').forEach(el => {
    el.addEventListener('click', () => {
      ta.track('segment_change', {
        segment: el.dataset.seg,
        consultId,
        segmentText: el.textContent?.trim()
      });
    });
  });

  // === Dr. AI Events ===
  const aiToggle = document.getElementById('btnAI');
  const aiSend = document.getElementById('aiSend');
  const aiText = document.getElementById('aiText');

  aiToggle?.addEventListener('click', () => {
    ta.track('dr_ai_open', { consultId });
  });

  aiSend?.addEventListener('click', () => {
    const text = aiText?.value?.trim() || '';
    if (text) {
      ta.track('dr_ai_question', { 
        consultId, 
        questionLength: text.length,
        hasKeywords: {
          symptoms: /sintoma|dor|febre|mal/i.test(text),
          diagnosis: /diagnós|CID|hipóte/i.test(text),
          treatment: /trata|medica|receita|conduta/i.test(text)
        }
      });
    }
  });

  // === Eventos do Formulário de Atendimento ===
  const fields = ['field-qp', 'field-hda', 'cidInput', 'field-cond', 'field-alert'];
  fields.forEach(fieldId => {
    const field = document.getElementById(fieldId);
    if (field) {
      field.addEventListener('blur', () => {
        const content = field.value?.trim() || '';
        if (content.length > 5) { // só rastreia se tem conteúdo significativo
          ta.track('form_field_filled', {
            consultId,
            field: fieldId,
            contentLength: content.length,
            fieldType: field.tagName.toLowerCase()
          });
        }
      });
    }
  });

  // === Exames ===
  document.getElementById('addExam')?.addEventListener('click', () => {
    const name = document.getElementById('ex-name')?.value?.trim() || '';
    const prio = document.getElementById('ex-prio')?.value || 'rotina';
    if (name) {
      ta.track('exam_add', { 
        consultId, 
        examName: name, 
        priority: prio,
        examType: name.toLowerCase().includes('sangue') ? 'blood' : 
                 name.toLowerCase().includes('urina') ? 'urine' : 'other'
      });
    }
  });

  // === MedMed Events ===
  const memedButtons = ['openMemed', 'openMemed2'];
  memedButtons.forEach(btnId => {
    document.getElementById(btnId)?.addEventListener('click', () => {
      ta.track('memed_open', { 
        consultId, 
        patientId,
        buttonSource: btnId
      });
    });
  });

  // Detecta quando uma receita é criada (via callback da demo)
  window.addEventListener('telemed:prescription-created', (e) => {
    ta.track('prescription_created', { 
      consultId, 
      prescriptionId: e.detail?.id,
      method: 'memed'
    });
  });

  // === Barra de Controles do Vídeo ===
  const videoControls = {
    'btnShot': 'screenshot',
    'btnOpenChat': 'chat_open',
    'btnBell': 'notifications',
    'btnMic': 'microphone_toggle',
    'btnCam': 'camera_toggle',
    'btnHold': 'hold_call',
    'btnEnd': 'end_call'
  };

  Object.entries(videoControls).forEach(([btnId, eventName]) => {
    document.getElementById(btnId)?.addEventListener('click', () => {
      ta.track(`toolbar_${eventName}`, { 
        consultId,
        timestamp: new Date().toISOString()
      });
    });
  });

  // === Eventos de Chat ===
  document.getElementById('send')?.addEventListener('click', () => {
    const message = document.getElementById('msg')?.value?.trim() || '';
    if (message) {
      ta.track('chat_message_sent', {
        consultId,
        messageLength: message.length,
        messageType: message.includes('?') ? 'question' : 'statement'
      });
    }
  });

  // === Eventos de Formulário (Salvar/Finalizar) ===
  document.getElementById('btnSave')?.addEventListener('click', () => {
    // Conta quantos campos estão preenchidos
    const filledFields = fields.filter(fieldId => {
      const field = document.getElementById(fieldId);
      return field?.value?.trim().length > 0;
    }).length;

    ta.track('consult_save', { 
      consultId,
      filledFields,
      totalFields: fields.length,
      completeness: Math.round((filledFields / fields.length) * 100)
    });
  });

  document.getElementById('btnFinish')?.addEventListener('click', () => {
    ta.track('consult_finalize', { 
      consultId,
      duration: document.getElementById('pbTimer')?.textContent || '00:00'
    });
  });

  // === Switches/Toggles ===
  document.querySelectorAll('.sw').forEach(sw => {
    sw.addEventListener('click', () => {
      const isActive = sw.classList.contains('on');
      ta.track('toggle_switch', {
        consultId,
        switchId: sw.id || 'unknown',
        newState: !isActive,
        switchType: sw.closest('[data-seg]')?.dataset.seg || 'general'
      });
    });
  });

  // === Redimensionamento do Painel ===
  const divider = document.getElementById('divider');
  if (divider) {
    let resizeStartTime;
    
    divider.addEventListener('pointerdown', () => {
      resizeStartTime = Date.now();
    });
    
    divider.addEventListener('pointerup', () => {
      if (resizeStartTime) {
        const duration = Date.now() - resizeStartTime;
        ta.track('panel_resize', {
          consultId,
          resizeDuration: duration,
          finalWidth: document.getElementById('rightPane')?.getBoundingClientRect()?.width || 0
        });
      }
    });

    divider.addEventListener('dblclick', () => {
      ta.track('panel_reset', { consultId, method: 'double_click' });
    });
  }

  // === Analytics Debug Console ===
  window.telemedEnhancedDebug = {
    showAnalytics() {
      console.group('📊 Enhanced Consultation Analytics');
      console.table(ta.all().filter(e => e.data.consultId === consultId));
      console.groupEnd();
    },
    exportSession() {
      const sessionData = ta.all().filter(e => 
        e.data.consultId === consultId || e.page.includes('enhanced')
      );
      console.log('Session Data:', sessionData);
      ta.downloadJSON();
    },
    clearSession() {
      ta.clear();
      console.log('Analytics cleared');
    }
  };

  // Track session duration periodically
  let sessionStartTime = Date.now();
  setInterval(() => {
    const duration = Math.floor((Date.now() - sessionStartTime) / 1000);
    if (duration % 60 === 0 && duration > 0) { // a cada minuto
      ta.track('session_heartbeat', {
        consultId,
        sessionDuration: duration,
        activeTab: document.querySelector('.tab.active')?.dataset.tab || 'unknown'
      });
    }
  }, 1000);

  console.log('🎯 TeleMed Enhanced Analytics loaded');
  console.log('Debug: window.telemedEnhancedDebug');
})();
</script>
</body>
</html>