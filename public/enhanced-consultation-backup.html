<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta Avan√ßada com IA - TeleMed Sistema</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-morphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .ai-pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .chat-bubble-doctor {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 18px 18px 4px 18px;
        }
        .chat-bubble-patient {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            border-radius: 18px 18px 18px 4px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- AI Consent Banner -->
    <div id="aiConsentBanner" class="bg-blue-50 border-b border-blue-200 p-4">
        <div class="max-w-6xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-shield-alt text-blue-600"></i>
                </div>
                <div>
                    <strong>Consentimento para IA M√©dica:</strong> Esta consulta utiliza recursos de
                    intelig√™ncia artificial para auxiliar no diagn√≥stico. Os dados s√£o processados de forma
                    segura e confidencial.
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="declineAI()" class="px-3 py-1 text-sm border border-gray-300 rounded text-gray-700 hover:bg-gray-50">
                    Recusar
                </button>
                <button onclick="acceptAI()" class="px-3 py-1 text-sm bg-blue-600 hover:bg-blue-700 text-white rounded">
                    Aceitar
                </button>
                <button onclick="dismissBanner()" class="p-1 text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Interface -->
    <div class="flex h-screen pt-16">
        <!-- Video Section -->
        <div class="w-2/3 bg-black relative">
            <!-- Video Placeholder -->
            <div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-gray-800 to-gray-900">
                <div class="text-center text-white">
                    <div class="w-24 h-24 mx-auto mb-4 bg-white/10 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-4xl"></i>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">Aguardando paciente...</h3>
                    <p class="text-gray-300">A chamada ser√° iniciada quando o paciente entrar</p>
                    <div class="mt-4">
                        <span class="bg-green-600 text-white px-3 py-1 rounded-full text-sm">
                            <i class="fas fa-circle text-xs mr-1"></i>
                            Conectado
                        </span>
                    </div>
                </div>
            </div>

            <!-- Video Controls -->
            <div class="absolute bottom-6 left-1/2 transform -translate-x-1/2">
                <div class="flex items-center gap-4 bg-black/50 backdrop-blur-sm rounded-full px-6 py-3">
                    <button class="w-12 h-12 bg-red-600 hover:bg-red-700 rounded-full flex items-center justify-center text-white">
                        <i class="fas fa-microphone-slash"></i>
                    </button>
                    <button class="w-12 h-12 bg-gray-600 hover:bg-gray-700 rounded-full flex items-center justify-center text-white">
                        <i class="fas fa-video-slash"></i>
                    </button>
                    <!-- Dr. AI Brain Button -->
                    <button id="btn-ai" class="w-12 h-12 bg-purple-600 hover:bg-purple-700 rounded-full flex items-center justify-center text-white" title="Dr. AI ‚Äì Assistente cl√≠nico">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M16 7a3 3 0 10-6 0 3 3 0 106 0z"/>
                            <path d="M8 10a4 4 0 00-4 4v2a3 3 0 003 3h1"/>
                            <path d="M16 10a4 4 0 014 4v1a4 4 0 01-4 4h-1"/>
                        </svg>
                    </button>
                    <button class="w-12 h-12 bg-blue-600 hover:bg-blue-700 rounded-full flex items-center justify-center text-white">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button id="btn-finish" onclick="endCall()" class="w-12 h-12 bg-red-600 hover:bg-red-700 rounded-full flex items-center justify-center text-white">
                        <i class="fas fa-phone-slash"></i>
                    </button>
                </div>
            </div>

            <!-- Timer -->
            <div class="absolute top-6 right-6 bg-black/50 backdrop-blur-sm rounded-lg px-4 py-2">
                <div class="text-white font-mono text-lg" id="consultationTimer">
                    00:00
                </div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="w-1/3 bg-white border-l">
            <!-- Tabs -->
            <div class="border-b">
                <div class="flex">
                    <button onclick="switchTab('chat')" class="tab-button px-4 py-3 text-sm font-medium border-b-2 border-blue-600 text-blue-600 bg-blue-50" data-tab="chat">
                        <i class="fas fa-comments mr-2"></i>Chat
                    </button>
                    <button onclick="switchTab('form')" class="tab-button px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700" data-tab="form">
                        <i class="fas fa-file-medical mr-2"></i>Atendimento
                    </button>
                    <button onclick="switchTab('exams')" class="tab-button px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700" data-tab="exams">
                        <i class="fas fa-flask mr-2"></i>Exames
                    </button>
                </div>
            </div>

            <!-- Chat Tab -->
            <div id="chatTab" class="tab-content flex flex-col h-full">
                <!-- Chat Messages -->
                <div class="flex-1 p-4 overflow-y-auto max-h-96" id="chatMessages">
                    <div class="space-y-4">
                        <div class="flex justify-start">
                            <div class="chat-bubble-patient p-3 text-sm text-gray-800 max-w-xs">
                                Ol√°, doutor! Como est√°?
                                <div class="text-xs text-gray-500 mt-1">14:32</div>
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <div class="chat-bubble-doctor p-3 text-sm text-white max-w-xs">
                                Ol√°! Estou bem, obrigado. Como posso ajud√°-lo hoje?
                                <div class="text-xs text-blue-100 mt-1">14:33</div>
                            </div>
                        </div>
                        <div class="flex justify-start">
                            <div class="chat-bubble-patient p-3 text-sm text-gray-800 max-w-xs">
                                Estou sentindo dores de cabe√ßa frequentes nos √∫ltimos dias.
                                <div class="text-xs text-gray-500 mt-1">14:34</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Input -->
                <div class="p-4 border-t">
                    <div class="flex items-center gap-2">
                        <input 
                            type="text" 
                            placeholder="Digite sua mensagem..."
                            class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            id="chatInput"
                            onkeypress="handleChatKeypress(event)"
                        >
                        <button onclick="sendMessage()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Form Tab -->
            <div id="formTab" class="tab-content hidden p-4 overflow-y-auto max-h-96">
                <h3 class="font-semibold text-gray-800 mb-4">Registro do Atendimento</h3>
                
                <!-- Patient Info -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Paciente</label>
                    <input type="text" value="Jo√£o Silva Santos" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly>
                </div>

                <!-- Chief Complaint -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Queixa Principal</label>
                    <textarea class="w-full px-3 py-2 border border-gray-300 rounded-lg resize-none" rows="2" placeholder="Descreva a queixa principal do paciente..."></textarea>
                </div>

                <!-- History -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Hist√≥ria da Doen√ßa Atual</label>
                    <textarea class="w-full px-3 py-2 border border-gray-300 rounded-lg resize-none" rows="3" placeholder="Descreva o hist√≥rico da doen√ßa atual..."></textarea>
                </div>

                <!-- Physical Exam -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Exame F√≠sico</label>
                    <textarea class="w-full px-3 py-2 border border-gray-300 rounded-lg resize-none" rows="2" placeholder="Descreva os achados do exame f√≠sico..."></textarea>
                </div>

                <!-- ICD-10 -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">CID-10</label>
                    <div class="relative">
                        <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Digite ou selecione um c√≥digo CID-10..." id="icdInput">
                        <div id="icdSuggestions" class="absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg mt-1 hidden z-10 max-h-40 overflow-y-auto">
                            <div class="p-2 hover:bg-gray-100 cursor-pointer border-b" onclick="selectICD('F41.1', 'Transtorno de ansiedade generalizada')">
                                <strong>F41.1</strong> - Transtorno de ansiedade generalizada
                            </div>
                            <div class="p-2 hover:bg-gray-100 cursor-pointer border-b" onclick="selectICD('F41.0', 'Ataque de p√¢nico')">
                                <strong>F41.0</strong> - Ataque de p√¢nico
                            </div>
                            <div class="p-2 hover:bg-gray-100 cursor-pointer border-b" onclick="selectICD('F32.1', 'Epis√≥dio depressivo moderado')">
                                <strong>F32.1</strong> - Epis√≥dio depressivo moderado
                            </div>
                            <div class="p-2 hover:bg-gray-100 cursor-pointer" onclick="selectICD('R50', 'Febre n√£o especificada')">
                                <strong>R50</strong> - Febre n√£o especificada
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Assistance -->
                <div class="mb-4 p-3 bg-gradient-to-r from-emerald-50 to-blue-50 border border-emerald-200 rounded-lg">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-6 h-6 bg-emerald-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-robot text-emerald-600 text-sm ai-pulse"></i>
                        </div>
                        <span class="font-medium text-emerald-800">Assistente IA</span>
                    </div>
                    <p class="text-sm text-emerald-700 mb-2">
                        Com base nos sintomas relatados (dores de cabe√ßa frequentes), sugiro investigar:
                    </p>
                    <div class="space-y-1 text-xs">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-lightbulb text-yellow-500"></i>
                            <span>Considerar enxaqueca (G43.9)</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-lightbulb text-yellow-500"></i>
                            <span>Avaliar tens√£o arterial</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-lightbulb text-yellow-500"></i>
                            <span>Investigar estresse/ansiedade</span>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="space-y-2">
                    <button id="btn-start" onclick="startConsultation()" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-medium transition-colors">
                        <i class="fas fa-play mr-2"></i>Iniciar Consulta
                    </button>
                    <button id="btn-save" onclick="saveConsultation()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-medium transition-colors">
                        <i class="fas fa-save mr-2"></i>Salvar Atendimento
                    </button>
                    <button onclick="finalizeConsultation()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg font-medium transition-colors">
                        <i class="fas fa-check mr-2"></i>Finalizar Consulta
                    </button>
                </div>
            </div>

            <!-- Exams Tab -->
            <div id="examsTab" class="tab-content hidden p-4 overflow-y-auto max-h-96">
                <h3 class="font-semibold text-gray-800 mb-4">Solicita√ß√£o de Exames</h3>
                
                <!-- Exam Templates -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Exames Sugeridos</label>
                    <div class="space-y-2">
                        <div class="p-2 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer" onclick="addExam('Hemograma completo')">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium">Hemograma completo</span>
                                <i class="fas fa-plus text-blue-600"></i>
                            </div>
                            <p class="text-xs text-gray-500">Jejum de 8-12 horas</p>
                        </div>
                        <div class="p-2 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer" onclick="addExam('Tomografia de cr√¢nio')">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium">Tomografia de cr√¢nio</span>
                                <i class="fas fa-plus text-blue-600"></i>
                            </div>
                            <p class="text-xs text-gray-500">Para investigar dores de cabe√ßa</p>
                        </div>
                        <div class="p-2 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer" onclick="addExam('Press√£o arterial (MAPA)')">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium">Press√£o arterial (MAPA)</span>
                                <i class="fas fa-plus text-blue-600"></i>
                            </div>
                            <p class="text-xs text-gray-500">Monitoramento 24h</p>
                        </div>
                    </div>
                </div>

                <!-- Selected Exams -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Exames Selecionados</label>
                    <div id="selectedExams" class="space-y-2">
                        <!-- Selected exams will appear here -->
                    </div>
                </div>

                <!-- Send Button -->
                <button class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg">
                    <i class="fas fa-paper-plane mr-2"></i>Enviar Solicita√ß√µes
                </button>
            </div>
        </div>
    </div>

    <script>
        let consultationStartTime = Date.now();
        let timerInterval;
        let aiConsentGiven = false;

        // Timer functionality
        function updateTimer() {
            const elapsed = Math.floor((Date.now() - consultationStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('consultationTimer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Tab functionality
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('border-blue-600', 'text-blue-600', 'bg-blue-50');
                btn.classList.add('text-gray-500');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            
            // Add active class to selected button
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            activeBtn.classList.add('border-blue-600', 'text-blue-600', 'bg-blue-50');
            activeBtn.classList.remove('text-gray-500');
        }

        // Chat functionality
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            const chatMessages = document.getElementById('chatMessages').querySelector('.space-y-4');
            const time = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex justify-end';
            messageDiv.innerHTML = `
                <div class="chat-bubble-doctor p-3 text-sm text-white max-w-xs">
                    ${message}
                    <div class="text-xs text-blue-100 mt-1">${time}</div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            input.value = '';
            
            // Scroll to bottom
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
        }

        function handleChatKeypress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // ICD-10 functionality
        function selectICD(code, description) {
            document.getElementById('icdInput').value = `${code} - ${description}`;
            document.getElementById('icdSuggestions').classList.add('hidden');
        }

        document.getElementById('icdInput').addEventListener('focus', function() {
            document.getElementById('icdSuggestions').classList.remove('hidden');
        });

        document.getElementById('icdInput').addEventListener('blur', function() {
            setTimeout(() => {
                document.getElementById('icdSuggestions').classList.add('hidden');
            }, 200);
        });

        // Exam functionality
        function addExam(examName) {
            const selectedExams = document.getElementById('selectedExams');
            const examDiv = document.createElement('div');
            examDiv.className = 'flex items-center justify-between p-2 bg-blue-50 border border-blue-200 rounded-lg';
            examDiv.innerHTML = `
                <span class="text-sm font-medium text-blue-800">${examName}</span>
                <button onclick="this.parentElement.remove()" class="text-red-600 hover:text-red-800">
                    <i class="fas fa-trash text-sm"></i>
                </button>
            `;
            selectedExams.appendChild(examDiv);
        }

        // AI Consent functionality
        function acceptAI() {
            aiConsentGiven = true;
            localStorage.setItem('ai_consent', 'true');
            document.getElementById('aiConsentBanner').style.display = 'none';
            console.log('‚úÖ Consentimento IA concedido');
        }

        function declineAI() {
            aiConsentGiven = false;
            localStorage.setItem('ai_consent', 'false');
            document.getElementById('aiConsentBanner').style.display = 'none';
            console.log('‚ùå Consentimento IA recusado');
        }

        function dismissBanner() {
            document.getElementById('aiConsentBanner').style.display = 'none';
        }

        function endCall() {
            if (confirm('Deseja encerrar a consulta?')) {
                finalizeConsultation();
            }
        }

        // === API Integration Functions ===
        const CONSULT_ID = new URLSearchParams(location.search).get('consultId') || 'demo-123';

        async function postJSON(url, body) {
            const r = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body || {})
            });
            if (!r.ok) throw new Error('HTTP ' + r.status);
            return r.json().catch(() => ({}));
        }

        // Start Consultation
        async function startConsultation() {
            try {
                await postJSON(`/api/consults/${CONSULT_ID}/start`);
                console.log('üè• Consulta iniciada');
                // Update UI status
                document.querySelector('#btn-start').textContent = '‚úÖ Consulta Iniciada';
                document.querySelector('#btn-start').disabled = true;
            } catch (e) {
                alert('Falha ao iniciar: ' + e.message);
            }
        }

        // Save Notes
        async function saveConsultation() {
            const payload = {
                chiefComplaint: document.querySelector('[name="chief_complaint"]')?.value || '',
                hpi: document.querySelector('[name="hpi"]')?.value || '',
                dx: document.querySelector('[name="dx"]')?.value || '',
                plan: document.querySelector('[name="plan"]')?.value || '',
                redFlags: document.querySelector('[name="red_flags"]')?.value || ''
            };
            try {
                await postJSON(`/api/consults/${CONSULT_ID}/notes`, payload);
                console.log('üìù Notas salvas');
                // Show feedback
                const btn = document.querySelector('#btn-save');
                const original = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check mr-2"></i>Salvo!';
                btn.classList.add('bg-green-600');
                setTimeout(() => {
                    btn.innerHTML = original;
                    btn.classList.remove('bg-green-600');
                }, 2000);
            } catch (e) {
                alert('Falha ao salvar: ' + e.message);
            }
        }

        // Finalize Consultation
        async function finalizeConsultation() {
            if (!confirm('Finalizar consulta? Esta a√ß√£o n√£o pode ser desfeita.')) return;
            try {
                await postJSON(`/api/consults/${CONSULT_ID}/finalize`);
                console.log('‚úÖ Consulta finalizada');
                alert('Consulta finalizada com sucesso!');
                window.location.href = '/patient-management';
            } catch (e) {
                alert('Falha ao finalizar: ' + e.message);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Start timer
            timerInterval = setInterval(updateTimer, 1000);
            
            // Check AI consent
            const savedConsent = localStorage.getItem('ai_consent');
            if (savedConsent === 'true') {
                aiConsentGiven = true;
                document.getElementById('aiConsentBanner').style.display = 'none';
            }
            
            console.log('üè• Enhanced Consultation Interface carregada');
            console.log('ü§ñ IA m√©dica:', aiConsentGiven ? 'Ativada' : 'Pendente de consentimento');
            console.log('‚è±Ô∏è Timer da consulta iniciado');
        });
        
        // === CID-10 Autocomplete ===
        function initCIDAutocomplete() {
            const cidInput = document.querySelector('input[placeholder*="CID"]') || document.querySelector('[name="dx"]');
            if (!cidInput) return;

            let cidDropdown;

            async function searchCID(query) {
                if (query.length < 2) {
                    cidDropdown?.remove();
                    return;
                }
                
                try {
                    const response = await fetch(`/api/cid10?query=${encodeURIComponent(query)}`);
                    const items = await response.json();
                    renderCIDDropdown(items.slice(0, 8));
                } catch (error) {
                    console.error('CID-10 search error:', error);
                }
            }

            function renderCIDDropdown(items) {
                cidDropdown?.remove();
                if (!items.length) return;

                cidDropdown = document.createElement('div');
                cidDropdown.className = 'cid-dropdown';
                cidDropdown.style.cssText = `
                    position: absolute; z-index: 1000; background: #fff; 
                    border: 1px solid rgba(0,0,0,.08); border-radius: 10px; 
                    margin-top: 6px; box-shadow: 0 10px 24px rgba(0,0,0,.12); 
                    max-height: 220px; overflow: auto; width: 100%;
                `;

                items.forEach(item => {
                    const option = document.createElement('div');
                    option.className = 'cid-option';
                    option.style.cssText = 'padding: 8px 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0;';
                    option.innerHTML = `<strong>${item.code}</strong> ‚Äì ${item.label}`;
                    option.addEventListener('mouseover', () => option.style.background = '#F3F8FF');
                    option.addEventListener('mouseout', () => option.style.background = '');
                    option.addEventListener('click', () => {
                        cidInput.value = `${item.code} ‚Äì ${item.label}`;
                        cidDropdown.remove();
                        cidInput.focus();
                    });
                    cidDropdown.appendChild(option);
                });

                const parent = cidInput.parentElement;
                parent.style.position = 'relative';
                parent.appendChild(cidDropdown);
            }

            cidInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                searchCID(query);
            });

            cidInput.addEventListener('blur', () => {
                setTimeout(() => cidDropdown?.remove(), 200);
            });
        }

        // Initialize CID autocomplete when page loads
        setTimeout(initCIDAutocomplete, 500);
    </script>

    <!-- ===== Dr. AI Panel ===== -->
<style>
  :root{
    --ai-bg:#fff; --ai-border:#e5e7eb; --ai-muted:#6b7280; --ai-primary:#2563eb;
    --ai-shadow:0 10px 30px rgba(0,0,0,.12);
  }
  #drAiPanel{
    position:fixed; inset:0 0 0 auto; width:420px; max-width:92vw; background:var(--ai-bg);
    box-shadow:var(--ai-shadow); border-left:1px solid var(--ai-border);
    transform:translateX(100%); transition:transform .25s ease; z-index:9999;
    display:flex; flex-direction:column; font-family:Inter,system-ui,Arial,sans-serif;
  }
  #drAiPanel.open{ transform:translateX(0) }
  #drAiHeader{ display:flex; align-items:center; justify-content:space-between; gap:8px;
    padding:12px 14px; border-bottom:1px solid var(--ai-border); background:#fafafa}
  #drAiHeader h3{ margin:0; font-size:16px }
  #drAiDisclaimer{ font-size:12px; color:var(--ai-muted); padding:8px 14px; border-bottom:1px solid var(--ai-border)}
  #drAiMessages{ flex:1; overflow:auto; padding:14px; display:flex; flex-direction:column; gap:12px}
  .ai-bubble{ padding:10px 12px; border:1px solid var(--ai-border); border-radius:12px; background:#fff }
  .ai-bubble.you{ align-self:flex-end; background:#eef2ff; border-color:#c7d2fe }
  .ai-bubble.assistant{ align-self:flex-start }
  #drAiQuick{ display:flex; gap:8px; flex-wrap:wrap; padding:8px 14px }
  .ai-chip{ font-size:12px; padding:6px 10px; border:1px solid #c7d2fe; border-radius:999px; background:#eef2ff; cursor:pointer }
  #drAiComposer{ display:flex; gap:8px; padding:12px 14px; border-top:1px solid var(--ai-border); background:#fafafa}
  #drAiInput{ flex:1; resize:none; padding:10px 12px; border-radius:10px; border:1px solid var(--ai-border); min-height:44px }
  #drAiSend{ background:var(--ai-primary); border:none; color:#fff; border-radius:10px; padding:0 14px; font-weight:600; cursor:pointer }
  #drAiClose{ background:transparent; border:1px solid var(--ai-border); padding:6px 10px; border-radius:8px; cursor:pointer }
  /* Bot√£o flutuante de fallback (se n√£o encontrarmos o bot√£o do c√©rebro) */
  #drAiFab{ position:fixed; right:18px; bottom:18px; z-index:9998; display:none }
  #drAiFab button{ width:52px; height:52px; border-radius:999px; border:none; background:#1f2937; color:#fff; box-shadow:var(--ai-shadow); cursor:pointer }
</style>

<div id="drAiPanel" aria-hidden="true">
  <div id="drAiHeader">
    <h3>üß† Dr. AI ‚Ä¢ suporte cl√≠nico (beta)</h3>
    <div style="display:flex; gap:8px;">
      <button id="drAiClear" title="Limpar conversa">Limpar</button>
      <button id="drAiClose" title="Fechar">Fechar</button>
    </div>
  </div>
  <div id="drAiDisclaimer">
    As respostas s√£o sugest√µes educacionais; a decis√£o cl√≠nica √© exclusiva do m√©dico respons√°vel.
  </div>
  <div id="drAiQuick">
    <span class="ai-chip" data-q="Explique em linguagem simples o diagn√≥stico prov√°vel e sinais de alarme.">Explicar diagn√≥stico</span>
    <span class="ai-chip" data-q="Sugira condutas baseadas em diretrizes para este caso (doses adultas e pedi√°tricas quando aplic√°vel).">Sugerir conduta</span>
    <span class="ai-chip" data-q="Monte um resumo conciso para o prontu√°rio com HDA, hip√≥tese, CID10, conduta e orienta√ß√µes.">Resumo p/ prontu√°rio</span>
    <span class="ai-chip" data-q="Quais exames iniciais s√£o mais √∫teis e quando evit√°-los? Justifique.">Exames √∫teis</span>
  </div>
  <div id="drAiMessages" role="log" aria-live="polite"></div>
  <div id="drAiComposer">
    <textarea id="drAiInput" placeholder="Pergunte algo ao Dr. AI‚Ä¶ (ex.: conduta para cefaleia cr√¥nica, quando solicitar imagem?)"></textarea>
    <button id="drAiSend">Enviar</button>
  </div>
</div>

<!-- Fallback: FAB se n√£o houver bot√£o do c√©rebro na barra -->
<div id="drAiFab"><button title="Abrir Dr. AI">üß†</button></div>

<script>
(() => {
  const panel   = document.getElementById('drAiPanel');
  const messagesEl = document.getElementById('drAiMessages');
  const input   = document.getElementById('drAiInput');
  const sendBtn = document.getElementById('drAiSend');
  const closeBtn= document.getElementById('drAiClose');
  const clearBtn= document.getElementById('drAiClear');
  const fabWrap = document.getElementById('drAiFab');

  // Liga no bot√£o do "c√©rebro" espec√≠fico que criamos
  const brainBtn = document.getElementById('btn-ai');
  if (brainBtn) {
    brainBtn.addEventListener('click', togglePanel);
    console.log('üß† Dr. AI conectado ao bot√£o c√©rebro');
  } else {
    // Sen√£o, mostra o FAB
    fabWrap.style.display = 'block';
    fabWrap.querySelector('button').addEventListener('click', togglePanel);
  }

  closeBtn.addEventListener('click', togglePanel);
  clearBtn.addEventListener('click', () => {
    messages.length = 0;
    messagesEl.innerHTML = '';
    localStorage.removeItem('drAiThread');
    appendAssistant('Conversa limpa. Em que posso ajudar?');
  });

  // Chips de atalho
  document.querySelectorAll('#drAiQuick .ai-chip').forEach(chip => {
    chip.addEventListener('click', () => {
      input.value = chip.getAttribute('data-q');
      input.focus();
    });
  });

  // Estado da conversa
  const messages = JSON.parse(localStorage.getItem('drAiThread') || '[]');
  if (messages.length === 0) {
    appendAssistant('Ol√°! Posso auxiliar com diagn√≥stico diferencial, conduta, exames √∫teis e resumo para prontu√°rio. Lembre-se: isso √© apoio √† decis√£o ‚Äî a decis√£o final √© sua. ‚úÖ');
  } else {
    // Restaura o log visual
    for (const m of messages) appendBubble(m.role, m.content);
  }

  sendBtn.addEventListener('click', onSend);
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); onSend(); }
  });

  function togglePanel(){
    const open = panel.classList.toggle('open');
    panel.setAttribute('aria-hidden', open ? 'false' : 'true');
    if (open) setTimeout(() => input.focus(), 50);
  }

  function onSend(){
    const text = (input.value || '').trim();
    if (!text) return;
    appendUser(text);
    input.value = '';
    askAI(text);
  }

  // Envia pergunta para o endpoint correto
  async function askAI(question) {
    const userMessage = { role: 'user', content: question };
    messages.push(userMessage);
    localStorage.setItem('drAiThread', JSON.stringify(messages));

    appendAssistant('‚è≥ Consultando...');

    const ctx = {
      chiefComplaint: document.querySelector('[name="chief_complaint"]')?.value || '',
      hpi: document.querySelector('[name="hpi"]')?.value || '',
      dx: document.querySelector('[name="dx"]')?.value || '',
      redFlags: document.querySelector('[name="red_flags"]')?.value || ''
    };
    
    try {
      const response = await fetch('/api/ai/clinical', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question, context: ctx })
      });
      
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const data = await response.json();
      
      const assistantMessage = { role: 'assistant', content: data.answer };
      messages.push(assistantMessage);
      localStorage.setItem('drAiThread', JSON.stringify(messages));

      // Remove "consultando" e adiciona resposta real
      messagesEl.removeChild(messagesEl.lastElementChild);
      appendAssistant(data.answer || 'Resposta n√£o dispon√≠vel');
    } catch (error) {
      console.error('Dr. AI Error:', error);
      // Remove "consultando" e adiciona erro
      messagesEl.removeChild(messagesEl.lastElementChild);
      appendAssistant('‚ö†Ô∏è N√£o foi poss√≠vel conectar com o Dr. AI. Tente novamente em alguns instantes.');
    }
  }

  function appendBubble(role, content){
    const div = document.createElement('div');
    div.className = 'ai-bubble ' + (role === 'user' ? 'you' : 'assistant');
    div.textContent = content;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }
  function appendUser(content){
    messages.push({ role:'user', content });
    persist();
    appendBubble('user', content);
  }
  function appendAssistant(content){
    messages.push({ role:'assistant', content });
    persist();
    appendBubble('assistant', content);
  }
  function persist(){
    localStorage.setItem('drAiThread', JSON.stringify(messages).slice(0, 200000)); // prote√ß√£o
  }

  async function askAI(newQuestion){
    // Contexto opcional capturado da tela (se existir)
    const patient = (document.querySelector('[name="patient"], #patientName')?.value || 
                     document.querySelector('.patient-name')?.textContent || '').trim();
    const hda     = document.querySelector('[name="hda"]')?.value || '';
    const dx      = document.querySelector('[name="diagnosis"], #diagnosisInput')?.value || '';
    const conduta = document.querySelector('[name="plan"]')?.value || '';

    const payload = {
      messages,
      context: { patient, hda, diagnosis: dx, plan: conduta }
    };

    // Placeholder "digitando‚Ä¶"
    const typing = document.createElement('div');
    typing.className = 'ai-bubble assistant';
    typing.textContent = 'Dr. AI est√° analisando‚Ä¶';
    messagesEl.appendChild(typing);
    messagesEl.scrollTop = messagesEl.scrollHeight;

    try{
      const r = await fetch('/api/dr-ai', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await r.json();
      typing.remove();

      const text = (data && (data.text || data.answer || data.message)) ||
        'N√£o consegui gerar uma resposta agora. Tente reformular a pergunta.';
      appendAssistant(text);
    }catch(err){
      typing.remove();
      appendAssistant('Falha ao contactar a IA. Verifique a rede/servidor e tente novamente.');
      console.error(err);
    }
  }
})();
</script>

</body>
</html>