<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Sala de Espera ‚Äî TeleMed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="canonical" href="/sala-de-espera" />
  <link rel="stylesheet" href="/css/theme-telemed.css" />
  <style>
    :root{--pri:#0ea5e9;--ink:#111827;--muted:#6b7280;--ok:#16a34a;--warn:#f59e0b;--err:#ef4444}
    body{background:linear-gradient(180deg,#f8fafc 0%,#eef2ff 100%)}
    .container{max-width:1100px;margin:0 auto;padding:20px}
    .header{display:flex;justify-content:space-between;align-items:center;background:#fff;border-radius:20px;padding:16px 20px;box-shadow:0 10px 26px rgba(2,6,23,.08);margin-bottom:16px}
    .title{margin:0;font-size:1.5rem}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:16px}
    .main{grid-template-columns:1.1fr .9fr}
    .card{background:#fff;border-radius:18px;box-shadow:0 8px 22px rgba(2,6,23,.06)}
    .card-body{padding:18px}
    .chip{display:inline-flex;gap:6px;align-items:center;border-radius:999px;padding:6px 10px;background:#eef2ff;color:#3730a3;font-weight:600}
    .status-dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:6px}
    .s-ok{background:var(--ok)} .s-warn{background:var(--warn)} .s-err{background:var(--err)} .s-idle{background:#9ca3af}
    .progress{height:10px;background:#eef2f7;border-radius:999px;overflow:hidden}
    .progress > div{height:100%;background:linear-gradient(90deg,#22d3ee,#3b82f6);width:0%}
    .video-wrap{background:#0b1220;border-radius:14px;display:grid;place-items:center;min-height:220px;color:#b3c1d1}
    video{width:100%;max-height:340px;border-radius:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .btn{display:inline-flex;gap:8px;align-items:center;padding:10px 14px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;cursor:pointer}
    .btn-primary{background:var(--pri);border-color:var(--pri);color:#fff}
    .btn-ghost{background:transparent;border-color:#e5e7eb}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .kpi .item{background:#f8fafc;border:1px solid #e5e7eb;border-radius:14px;padding:12px;text-align:center}
    .kpi .num{font-weight:800;font-size:1.4rem}
    .right .card{height:100%}
    @media(max-width:1024px){.main{grid-template-columns:1fr}}
    .note{font-size:.9rem;color:var(--muted)}
    .danger{color:var(--err);font-weight:600}
    .success{color:var(--ok);font-weight:600}
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div>
        <h1 class="title">Sala de Espera</h1>
        <div id="sub" class="muted">Seu m√©dico est√° se preparando‚Ä¶</div>
      </div>
      <div class="row">
        <a class="btn" href="/dashboard">‚Üê Voltar</a>
        <button id="help" class="btn">‚ùì Ajuda</button>
      </div>
    </header>

    <section class="grid main">
      <!-- Coluna principal -->
      <div class="left grid">
        <!-- Status da fila -->
        <article class="card">
          <div class="card-body">
            <div class="row" style="justify-content:space-between;align-items:center">
              <div class="row">
                <span class="status-dot s-idle" id="statusDot"></span>
                <strong id="statusTxt">Aguardando</strong>
                <span class="chip" id="ticketChip">C√≥digo: ‚Äî</span>
              </div>
              <button id="refresh" class="btn">‚Üª Atualizar</button>
            </div>

            <div class="kpi" style="margin-top:12px">
              <div class="item"><div class="num" id="pos">‚Äî</div><div>Posi√ß√£o na fila</div></div>
              <div class="item"><div class="num" id="eta">‚Äî</div><div>Tempo estimado</div></div>
              <div class="item"><div class="num" id="ahead">‚Äî</div><div>Na sua frente</div></div>
            </div>

            <div class="progress" style="margin:14px 0 6px">
              <div id="bar"></div>
            </div>
            <div class="note">Esta √© uma estimativa ‚Äî ela se atualiza automaticamente.</div>

            <div id="cta" style="margin-top:14px"></div>
          </div>
        </article>

        <!-- Testes de √°udio e v√≠deo -->
        <article class="card">
          <div class="card-body">
            <h3>Teste r√°pido de √°udio e v√≠deo</h3>
            <div class="video-wrap" id="videoWrap">
              <video id="cam" playsinline autoplay muted></video>
              <div id="noCam" class="note">Conceda permiss√£o para c√¢mera/microfone para ver a pr√©via.</div>
            </div>
            <div class="row" style="margin-top:10px">
              <button id="btnCam" class="btn btn-primary">üé• Iniciar c√¢mera</button>
              <button id="btnMic" class="btn">üé§ Testar microfone</button>
              <button id="btnStop" class="btn btn-ghost">‚èπÔ∏è Parar</button>
            </div>
            <div id="micLevel" class="note">N√≠vel do microfone: ‚Äî</div>
          </div>
        </article>

        <!-- Mensagem para o m√©dico -->
        <article class="card">
          <div class="card-body">
            <h3>Deixe uma mensagem para o m√©dico</h3>
            <textarea id="msg" rows="3" style="width:100%;border-radius:12px;border:1px solid #e5e7eb;padding:10px" placeholder="Ex.: Preciso avisar que estou com febre desde ontem‚Ä¶"></textarea>
            <div class="row" style="margin-top:10px">
              <button id="send" class="btn">‚úâÔ∏è Enviar mensagem</button>
              <span id="sendStatus" class="note"></span>
            </div>
          </div>
        </article>
      </div>

      <!-- Coluna lateral -->
      <aside class="right">
        <article class="card">
          <div class="card-body">
            <h3>Seu atendimento</h3>
            <div id="who" class="note" style="margin-bottom:10px"></div>

            <h4>Notifica√ß√µes</h4>
            <div class="row">
              <label class="row"><input id="notif" type="checkbox" style="transform:scale(1.2)"> Ativar notifica√ß√£o quando for chamado</label>
              <span id="notifState" class="note"></span>
            </div>

            <h4 style="margin-top:14px">Checklist</h4>
            <ul class="note">
              <li>Ambiente silencioso e com boa ilumina√ß√£o</li>
              <li>Documento com foto em m√£os</li>
              <li>Fone de ouvido (opcional, melhora o som)</li>
              <li>Conex√£o est√°vel (Wi-Fi ou 4G/5G)</li>
            </ul>

            <h4 style="margin-top:14px">Dicas r√°pidas</h4>
            <details><summary>Minha c√¢mera n√£o aparece</summary><div class="note">Verifique permiss√µes do navegador e feche outros apps que usam a c√¢mera.</div></details>
            <details><summary>O m√©dico atrasou</summary><div class="note">Aguarde ‚Äî a equipe pode estar finalizando o atendimento anterior. Se preferir, reagende pela <a href="/agenda">Agenda</a>.</div></details>
          </div>
        </article>
      </aside>
    </section>
  </div>

  <script>
  (function(){
    // util
    const $=(s,r=document)=>r.querySelector(s);
    const qs=new URLSearchParams(location.search);
    const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));
    const fmtM=(n)=>String(n).padStart(2,'0');

    // dados iniciais via querystring
    const ticket = qs.get('ticket')||'‚Äî';
    const nome   = qs.get('nome')||'Paciente';
    const medico = qs.get('medico')||'Seu M√©dico';
    const esp    = qs.get('especialidade')||qs.get('esp')||'Cl√≠nica Geral';
    const hora   = qs.get('horario')||'‚Äî';
    const mock   = qs.has('mock'); // modo demo

    // UI inicial
    $('#ticketChip').textContent = 'C√≥digo: ' + ticket;
    $('#who').innerHTML = `<strong>${nome}</strong> ‚Ä¢ ${esp}<br>M√©dico: <strong>${medico}</strong> ‚Ä¢ Hor√°rio: <strong>${hora}</strong>`;
    $('#sub').textContent = 'Fique √† vontade ‚Äî avisaremos quando for a sua vez.';

    // status
    let progress=0, called=false, stream=null, micAnalyser=null, micRAF=null;

    function setStatus(kind, txt){
      const map={idle:'s-idle', ok:'s-ok', warn:'s-warn', err:'s-err'};
      $('#statusDot').className='status-dot '+(map[kind]||'s-idle');
      $('#statusTxt').textContent=txt;
    }
    function setKpis(p, etaMin, ahead){
      $('#pos').textContent = p;
      $('#eta').textContent = etaMin ? `${etaMin} min` : '‚Äî';
      $('#ahead').textContent = ahead ?? '‚Äî';
      progress = Math.max(0, Math.min(100, Math.round((p>0? (1/(p)):1)*100)));
      $('#bar').style.width = progress + '%';
    }
    function setCTA(status){
      const box=$('#cta');
      if(status==='ready'){
        setStatus('ok','Chamado!'); 
        box.innerHTML = `<a class="btn btn-primary" id="go" href="/consulta?ticket=${encodeURIComponent(ticket)}">Entrar na consulta</a> <span class="note">Voc√™ ser√° redirecionado automaticamente em 5s‚Ä¶</span>`;
        setTimeout(()=>{ const go=$('#go'); if(go) go.click(); }, 5000);
      }else{
        box.innerHTML='';
      }
    }

    // Poll de status ‚Äî integra√ß√£o:
    // Ideal: GET /api/consultas/status?ticket=... -> {status:'waiting|ready|cancelled', position, ahead, etaMin}
    async function fetchStatus(){
      if(mock){
        // simula√ß√£o: depois de algumas itera√ß√µes o paciente √© chamado
        const start=(window._mockStart||(window._mockStart=Date.now()));
        const elapsed = (Date.now()-start)/1000;
        const phase = Math.floor(elapsed/20); // muda a cada 20s
        const position = Math.max(1, 3-phase);
        const etaMin = Math.max(0, 6 - phase*2);
        const status = phase>=3 ? 'ready' : 'waiting';
        return {status, position, ahead:Math.max(0, position-1), etaMin};
      }
      try{
        const res = await fetch(`/api/consultas/status?ticket=${encodeURIComponent(ticket)}&t=${Date.now()}`, {cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        return await res.json();
      }catch(e){
        console.warn('status fallback', e);
        return {status:'waiting', position:2, ahead:1, etaMin:3}; // fallback seguro
      }
    }

    async function poll(){
      const data = await fetchStatus();
      setKpis(data.position ?? 2, data.etaMin ?? 3, data.ahead ?? 1);
      if(data.status==='ready' && !called){ called=true; setCTA('ready'); notify('Chegou a sua vez! Clique para entrar.'); }
      else if(data.status==='waiting'){ setStatus('warn','Aguardando'); setCTA('waiting'); }
      else if(data.status==='cancelled'){ setStatus('err','Consulta cancelada'); setCTA('cancelled'); }
    }

    // notifica√ß√µes
    function notify(msg){
      if(!('Notification' in window)) return;
      if(Notification.permission==='granted'){ new Notification('TeleMed', {body:msg}); }
    }
    $('#notif').addEventListener('change', async (e)=>{
      if(e.target.checked){
        try{
          const perm = await Notification.requestPermission();
          $('#notifState').textContent = (perm==='granted') ? 'Notifica√ß√µes ativadas.' : 'Permiss√£o negada.';
        }catch{ $('#notifState').textContent='N√£o suportado no navegador.'; }
      }else{
        $('#notifState').textContent='Notifica√ß√µes desativadas.';
      }
    });

    // c√¢mera/microfone
    async function startCam(){
      try{
        stream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
        $('#cam').srcObject = stream;
        $('#noCam').style.display='none';
        // mic level
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const src = ctx.createMediaStreamSource(stream);
        micAnalyser = ctx.createAnalyser(); micAnalyser.fftSize=512;
        src.connect(micAnalyser);
        const buf = new Uint8Array(micAnalyser.frequencyBinCount);
        const loop = ()=>{ micAnalyser.getByteFrequencyData(buf); const v = Math.round(buf.reduce((a,b)=>a+b,0)/buf.length/2.55); $('#micLevel').textContent='N√≠vel do microfone: '+v+'%'; micRAF=requestAnimationFrame(loop); };
        loop();
      }catch(e){
        $('#noCam').textContent='N√£o foi poss√≠vel acessar c√¢mera/microfone: '+e.message;
      }
    }
    function stopMedia(){
      if(micRAF) cancelAnimationFrame(micRAF);
      if(stream) stream.getTracks().forEach(t=>t.stop());
      stream=null; $('#cam').srcObject=null; $('#noCam').style.display='';
      $('#micLevel').textContent='N√≠vel do microfone: ‚Äî';
    }
    $('#btnCam').addEventListener('click', startCam);
    $('#btnStop').addEventListener('click', stopMedia);
    $('#btnMic').addEventListener('click', ()=> notify('Se voc√™ ouviu este alerta, as notifica√ß√µes est√£o funcionando.'));

    // mensagem para o m√©dico ‚Äî integra√ß√£o: POST /api/consultas/mensagem {ticket, texto}
    $('#send').addEventListener('click', async ()=>{
      const texto = $('#msg').value.trim();
      if(!texto) return;
      try{
        if(!mock){
          await fetch('/api/consultas/mensagem', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ticket, texto})});
        }
        $('#sendStatus').textContent='Mensagem enviada üëç'; $('#msg').value='';
        setTimeout(()=>$('#sendStatus').textContent='', 2500);
      }catch{ $('#sendStatus').textContent='Falha ao enviar. Tente novamente.'; }
    });

    // refresh manual
    $('#refresh').addEventListener('click', poll);
    $('#help').addEventListener('click', ()=> alert('D√∫vidas comuns:\n‚Ä¢ Permita acesso √† c√¢mera/microfone\n‚Ä¢ Ative notifica√ß√µes para ser avisado\n‚Ä¢ Voc√™ entra automaticamente quando for chamado'));

    // loop de atualiza√ß√£o
    poll();
    setInterval(poll, 15000); // 15s
  })();
  </script>
</body>
</html>